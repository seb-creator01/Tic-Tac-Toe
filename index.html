<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>XOX ARENA</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        /* --- THEME COLORS --- */
        :root {
            --color-primary-accent: #00bfff; /* Electric Blue */
            --color-secondary-accent: #39ff14; /* Neon Green */
            --color-dark-bg: #0f0f0f;
            --color-panel-bg: #16161a;
            --color-text-light: #eeeeee;
            --color-text-dark: #0f0f0f;
            --color-cell-bg: #242629;
            --color-cell-hover: #393e46;
            
            /* CSS Variable set by JS for reliable mobile viewport height */
            --vh: 1vh;
            --dynamic-board-size: 300px; /* Default, will be set by JS */
        }

        /* --- LIGHT THEME --- */
        .light-theme {
            --color-primary-accent: #1e88e5; 
            --color-secondary-accent: #ffb300; 
            --color-dark-bg: #f0f0f0;
            --color-panel-bg: #ffffff;
            --color-text-light: #333333;
            --color-text-dark: #ffffff;
            --color-cell-bg: #e0e0e0;
            --color-cell-hover: #cfcfcf;
        }

        /* --- CORE LAYOUT FIX --- */
        * {
            box-sizing: border-box;
        }

        html, body {
            /* CRITICAL FIX 2: Use the JS-calculated variable for reliable mobile height */
            height: calc(var(--vh, 1vh) * 100); 
            width: 100%;
            margin: 0; 
            padding: 0; 
            overflow: hidden; /* Prevents global scroll */
            font-family: 'Roboto', 'Segoe UI', sans-serif; 
            background: var(--color-dark-bg);
            color: var(--color-text-light); 
            text-align: center; 
            display: flex; /* Use flexbox to manage the single column layout */
            flex-direction: column;
            align-items: center; /* Center content horizontally */
            transition: background 0.3s, color 0.3s; 
            user-select: none;
        }

        h1, h2, h3 { 
            font-weight: 900;
            color: var(--color-primary-accent); 
            text-shadow: 0 0 8px rgba(0, 191, 255, 0.5); 
            margin-top: 10px;
        }

        h1 { font-size: 2.5rem; }

        .screen {
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
            display: none; 
            padding: 0 20px; 
            box-sizing: border-box;
            background: var(--color-dark-bg); 
            flex-direction: column;
            animation: fadeIn 0.3s ease-in-out;
            z-index: 100; 
            overflow-y: auto; /* Allow scrolling for tall menu screens */
            flex-grow: 1; /* Allows the screen to take up remaining height */
            padding-bottom: 50px; /* Space for the footer */
        }

        .screen.active { 
            display: flex; 
        }

        /* --- GAME SCREEN SPECIFIC LAYOUT --- */
        #game-screen .screen-content {
            display: flex;
            flex-direction: column;
            align-items: center; 
            height: 100%; 
            padding-top: 10px; 
            box-sizing: border-box;
            overflow-y: hidden; /* Prevent scrolling inside the game area */
        }

        #game-info-header,
        #player-names-display, 
        #game-info,
        #scoreboard,
        #post-game-actions {
            width: 95%;
            max-width: 450px;
            margin-bottom: 5px; 
            flex-shrink: 0; /* Ensures these headers/footers take fixed space */
        }

        /* CRITICAL RENDER FIX: BOARD CONTAINER */
        #game-board-container {
            flex-grow: 1; /* Takes all available remaining height */
            min-height: 0; 
            width: 100%; 
            max-width: 450px; 
            display: flex; 
            justify-content: center;
            align-items: center; 
            overflow: hidden; 
            margin: 5px 0; 
            height: 100%; 
        }

        /* --- GAME BOARD (DYNAMIC GRID DEFINITION) --- */
        #game { 
            display: grid; 
            grid-template-columns: repeat(var(--board-size), 1fr);
            grid-gap: 8px; 
            padding: 10px;
            background: var(--color-panel-bg); 
            border-radius: 12px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.5), inset 0 0 10px rgba(0, 0, 0, 0.3);
            
            /* CRITICAL FIX 3: Use JS-set variable for width and enforce square ratio */
            width: var(--dynamic-board-size); 
            aspect-ratio: 1 / 1; 
            max-width: 450px; 
            max-height: 100%; 
        }

        .cell { 
            aspect-ratio: 1 / 1; 
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: var(--font-size, 3rem); 
            font-weight: 900;
            cursor: pointer;
            background: var(--color-cell-bg); 
            color: var(--color-text-light); 
            border-radius: 5px;
            transition: background 0.2s, color 0.2s, box-shadow 0.2s;
        }

        .cell:hover { 
            background: var(--color-cell-hover);
        }

        .cell.winner {
            background: var(--color-primary-accent);
            color: var(--color-text-dark);
            box-shadow: 0 0 10px var(--color-primary-accent);
        }

        /* --- BUTTONS & INPUTS --- */
        button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            cursor: pointer;
            background: var(--color-primary-accent);
            color: var(--color-text-dark);
            font-weight: 700;
            transition: background 0.2s, transform 0.1s;
        }

        button:hover:not(.active) {
            background: #008cba;
        }

        button.active {
            background: var(--color-secondary-accent);
            color: var(--color-text-dark);
            box-shadow: 0 0 10px var(--color-secondary-accent);
        }

        /* --- RESPONSIVE FIXES --- */
        @media (max-width: 600px) {
            /* Adjust the font-size for small screens */
            :root {
                --font-size: 2rem;
            }
            #game-board-container {
                max-width: 100%;
            }
        }
    </style>
</head>
<body id="app-body">
    <button id="muteBtn" onclick="toggleMute()" class="fixed-control">üîä</button>
    <button id="backBtn" onclick="handleBack(true)" class="fixed-control">‚Üê Back</button>
    <button id="chatOpenBtn" onclick="toggleChatOverlay()" class="fixed-control">üí¨ Chat</button>

    <div id="splash-screen" class="screen active">
        <div class="screen-content">
            <p>Seb Creations Presents</p>
            <h1>XOX ARENA</h1>
            <p id="tagline">‚ÄúThink Fast. Strike Smart. Rule the Grid.‚Äù</p>
            
            <button id="play-button" onclick="handlePlayClick()">PLAY GAME</button>
            
            <div id="loading-spinner"></div>
        </div>
    </div>

    <div id="home-screen" class="screen">
        <div class="screen-content">
            <h1>XOX ARENA</h1>
            <p id="tagline" style="margin-top: 0;">‚ÄúThink Fast. Strike Smart. Rule the Grid.‚Äù</p>
            
            <div id="theme-controls" style="margin-bottom: 30px;">
                <h3>Theme</h3>
                <button onclick="setTheme('dark')" class="active">Dark (Neon)</button>
                <button onclick="setTheme('light')">Light</button>
            </div>
            
            <div id="main-controls" style="display: flex; flex-direction: column; align-items: center; margin-top: 50px;">
                <button onclick="showScreen('local-config')" class="neon-button">LOCAL 2-PLAYER</button>
                <button onclick="showScreen('ai-config')" class="neon-button">PLAY AI</button> 
                <button onclick="showScreen('online-lobby')" class="neon-button">ONLINE MULTIPLAYER</button>
            </div>
        </div>
    </div>

    <!-- Your other screens go here -->

    <script>
        // --- CRITICAL FIX 1: Fix Mobile Viewport Height (vh) Issues ---
        function setViewportHeight() {
            let vh = window.innerHeight * 0.01;
            document.documentElement.style.setProperty('--vh', `${vh}px`);
        }

        window.addEventListener('resize', setViewportHeight); // Recalculate on resize
        setViewportHeight(); // Initial height calculation on page load

        // --- TIMER STATE VARIABLES ---
        let timerInterval = null;
        let localMoveStartTime = Date.now();
        const TIME_LIMIT_SECONDS = 30;
        let autoResetTimeout = null;

        // --- BOARD SIZE CALCULATION AND REDRAW ---
        function calculateAndSetBoardSize() {
            if (currentScreen !== 'game-screen' || !gameBoardContainer || !gameDiv) return;

            // Get the dimensions of the game-screen content area
            const gameScreenContent = document.querySelector('#game-screen .screen-content');
            const containerRect = gameScreenContent.getBoundingClientRect();

            const fixedHeight = gameInfoHeader.offsetHeight + scoreboardDiv.offsetHeight + postGameActionsDiv.offsetHeight + 60;

            const availableWidth = containerRect.width;
            const availableHeight = containerRect.height - fixedHeight;

            let finalBoardSize = Math.min(availableWidth, availableHeight);
            finalBoardSize = Math.min(finalBoardSize, 450); // Max width

            const boardPadding = 20;
            finalBoardSize = Math.max(0, finalBoardSize - boardPadding);

            gameDiv.style.setProperty('--dynamic-board-size', `${finalBoardSize}px`);
            
            const size = boardSize;
            const gapSpace = 8 * (size - 1);
            const cellSideLength = (finalBoardSize - gapSpace) / size;
            const fontSize = cellSideLength / 2.5;

            gameDiv.style.setProperty('--font-size', `${fontSize}px`);
            drawBoard();
        }

        // Call calculateAndSetBoardSize whenever the screen is resized or orientation changes
        window.addEventListener('resize', calculateAndSetBoardSize);
    </script>
</body>
</html>
