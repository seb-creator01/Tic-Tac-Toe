<!DOCTYPE html>
<html lang="en" data-theme="dark" style="height: 100vh; overflow: hidden;">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>XOX ARENA</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        /* --- THEME COLORS (DEFAULT: DARK MODE) --- */
        :root {
            /* Base Theme (Dark) */
            --color-bg-main: #0f0f0f;
            --color-panel-bg: #16161a;
            --color-text-light: #eeeeee;
            --color-text-dark: #111111;
            /* Accent Colors (Default: Blue Neon) */
            --color-primary-accent: #00bfff; /* X default */
            --color-secondary-accent: #39ff14; /* O default */
        }
        
        /* --- ACCENT THEME: RED NEON --- */
        [data-accent="red"] {
            --color-primary-accent: #ff4500; /* Red Orange */
            --color-secondary-accent: #f0f0f0; /* White/Light Grey */
        }

        /* --- UI THEME: LIGHT MODE (NEW) --- */
        [data-theme="light"] {
            --color-bg-main: #f0f0f0;
            --color-panel-bg: #ffffff;
            --color-text-light: #111111;
            --color-text-dark: #eeeeee;
        }

        /* --- CRITICAL LAYOUT & FONT --- */
        html, body {
            height: 100%;
            height: calc(var(--vh, 1vh) * 100); 
            margin: 0; 
            padding: 0; 
            overflow: hidden; 
            font-family: 'Roboto', 'Segoe UI', sans-serif; 
            background: var(--color-bg-main);
            color: var(--color-text-light); 
            text-align: center; 
            display: flex;
            flex-direction: column;
            align-items: center;
            user-select: none;
            transition: background 0.3s, color 0.3s;
        } 

        h1, h2, h3 { 
            font-weight: 900;
            color: var(--color-primary-accent); 
            text-shadow: 0 0 8px var(--color-primary-accent); /* Themed Neon Glow */
            margin-top: 10px;
        }
        
        h1 { font-size: 2.5rem; }
        
        .screen {
            width: 100%;
            height: 100%;
            height: calc(var(--vh, 1vh) * 100); 
            max-width: 600px;
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            display: none; 
            padding: 20px;
            box-sizing: border-box;
            background: var(--color-bg-main); 
            flex-direction: column;
            animation: fadeIn 0.3s ease-in-out;
            z-index: 100; 
        }
        
        .screen.active { 
            display: flex; 
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .screen-content {
            flex-grow: 1; 
            overflow-y: auto; 
            padding-top: 40px; 
            padding-bottom: 50px; 
        }

        /* --- BUTTONS & INPUTS --- */
        button { 
            padding: 14px 30px; 
            margin: 8px; 
            border: none; 
            background: var(--color-panel-bg); 
            color: var(--color-text-light); 
            font-weight: 700; 
            border-radius: 10px; 
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.4);
            font-size: 1rem;
            letter-spacing: 0.5px;
            cursor: pointer;
            transition: background 0.2s, color 0.2s, box-shadow 0.2s, transform 0.1s; 
        } 
        
        .neon-button {
            border: 2px solid var(--color-secondary-accent);
            color: var(--color-secondary-accent);
            box-shadow: 0 0 15px var(--color-secondary-accent), inset 0 0 8px var(--color-secondary-accent); 
            margin: 12px 8px;
        }
        .neon-button:hover {
            background: color-mix(in srgb, var(--color-secondary-accent) 15%, transparent); 
            color: var(--color-text-light);
            transform: translateY(-3px);
            box-shadow: 0 0 20px var(--color-secondary-accent), 0 6px 12px rgba(0, 0, 0, 0.6);
        }
        
        button.active { 
            background: var(--color-secondary-accent); 
            color: var(--color-text-dark); 
            box-shadow: 0 0 10px var(--color-secondary-accent), 0 4px 8px rgba(0, 0, 0, 0.5); 
            transform: translateY(-2px); 
        } 

        /* --- GAME BOARD --- */
        #game-board-container {
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative; /* For strike line */
            padding: 20px 0;
        }

        #game {
            display: grid;
            gap: 5px;
            width: 90vw; 
            max-width: 400px; 
            grid-template-columns: repeat(var(--board-size), 1fr);
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.1);
            background: #202020;
            position: relative;
        }
        
        .cell {
            background: var(--color-panel-bg);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: var(--font-size); 
            font-weight: 900;
            cursor: pointer;
            aspect-ratio: 1 / 1; 
            border-radius: 5px;
            transition: background 0.1s;
        }
        
        .cell:empty:hover {
            background: rgba(255, 255, 255, 0.05);
        }
        
        .cell:not(:empty) {
            cursor: default;
        }

        /* Themed X and O colors/shadows */
        .cell:nth-child(n):not(:empty) {
            color: var(--color-primary-accent);
            text-shadow: 0 0 10px var(--color-primary-accent);
        }

        .cell:nth-child(n):not(:empty):nth-child(even) {
            color: var(--color-secondary-accent);
            text-shadow: 0 0 10px var(--color-secondary-accent);
        }

        .cell.winner {
            background: rgba(255, 255, 255, 0.1);
        }

        /* --- WINNING LINE ANIMATION --- */
        .strike-line {
            position: absolute;
            background-color: var(--color-primary-accent); 
            box-shadow: 0 0 15px var(--color-primary-accent);
            z-index: 50; 
            border-radius: 5px;
            transition: width 0.3s ease-out, height 0.3s ease-out, transform 0.3s ease-out;
            pointer-events: none;
        }
        
        /* --- ONLINE LOBBY STATUS VISIBILITY IMPROVEMENT --- */
        #onlineStatus {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--color-primary-accent);
            text-shadow: 0 0 5px rgba(0, 191, 255, 0.5);
            padding: 15px;
            margin: 20px 0;
            border: 1px solid var(--color-panel-bg);
            border-radius: 8px;
            background: var(--color-panel-bg);
            word-break: break-word; 
        }
        
        /* --- TIMER COUNTDOWN STYLES --- */
        #timer {
            font-size: 1.2rem;
            font-weight: 700;
            margin: 5px 0;
        }
        
        /* --- THEME SELECTION STYLES --- */
        .theme-control-group {
            margin-bottom: 40px; 
            border: 1px solid #333; 
            padding: 10px; 
            border-radius: 8px;
            background: var(--color-panel-bg);
        }
        
        .theme-select-button {
            border: 2px solid var(--color-text-light);
            padding: 10px 20px;
            margin: 5px;
            border-radius: 20px;
            font-weight: 700;
        }
        .theme-select-button.active {
            border: 4px solid var(--color-secondary-accent);
            box-shadow: 0 0 10px var(--color-secondary-accent);
            transform: scale(1.05);
        }

        /* New Light/Dark Mode Buttons */
        .theme-dark { background: #111; color: #fff; }
        .theme-light { background: #ddd; color: #111; }

        /* Accent Buttons */
        .accent-blue { background: #00bfff; color: var(--color-text-dark); }
        .accent-red { background: #ff4500; color: var(--color-text-dark); }
        .accent-green { background: #39ff14; color: var(--color-text-dark); }

        /* --- PLAYER CUSTOMIZATION INPUT --- */
        #player-config-controls input {
            padding: 10px;
            margin: 10px;
            border: 1px solid #333;
            border-radius: 5px;
            background: var(--color-panel-bg);
            color: var(--color-text-light);
            text-align: center;
            font-size: 1.2rem;
            width: 50px;
        }

        /* --- CHAT OVERLAY (SWIPE CAPABILITY) --- */
        #chat-overlay {
            position: absolute;
            top: 0;
            right: 0;
            width: 80%;
            max-width: 350px;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(5px);
            z-index: 150; 
            transform: translateX(100%);
            transition: transform 0.3s ease-out;
            padding: 10px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            border-left: 2px solid var(--color-primary-accent);
            
            /* Enable swipe down/up for vertical scroll, block horizontal scroll */
            touch-action: pan-y; 
        }

        #chat-overlay.visible {
            transform: translateX(0);
        }
        
        /* --- TOAST POPUP (NEW) --- */
        #toast-container {
            position: fixed;
            bottom: 60px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 300; 
            pointer-events: none;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .toast {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(5px);
            color: var(--color-text-light);
            padding: 10px 20px;
            margin-top: 10px;
            border-radius: 15px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
            opacity: 0;
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            transform: translateY(20px);
            font-weight: 700;
        }
        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }

    </style>
</head>
<body>
    
    <button id="muteBtn" onclick="toggleMute()" class="fixed-control" style="top: 10px; left: 10px; z-index: 101;">üîä</button>
    <button id="backBtn" onclick="handleBack(true)" class="fixed-control" style="top: 10px; left: 80px; z-index: 101; display: none;">‚Üê Back</button>
    <button id="chatOpenBtn" onclick="toggleChatOverlay()" class="fixed-control" style="top: 10px; right: 10px; z-index: 101; display: none;">üí¨ Chat</button>

    <div id="toast-container"></div>

    <div id="splash-screen" class="screen">
        <p>Seb Creations Presents</p>
        <h1>XOX ARENA</h1>
        <p id="tagline">‚ÄúThink Fast. Strike Smart. Rule the Grid.‚Äù</p>
        
        <button id="play-button" onclick="handlePlayClick()">PLAY GAME</button>
        
        <div id="loading-spinner" style="display: none; margin-top: 20px;">
            <p>Loading Assets...</p>
        </div>
    </div>

    <div id="home-screen" class="screen">
        <div class="screen-content">
            <h1>XOX ARENA</h1>
            <p id="tagline" style="margin-top: 0;">‚ÄúThink Fast. Strike Smart. Rule the Grid.‚Äù</p>
            
            <div id="ui-theme-controls" class="theme-control-group">
                <h3>UI Theme Mode</h3>
                <button class="theme-select-button theme-dark active" onclick="setTheme('dark', this)">Dark</button>
                <button class="theme-select-button theme-light" onclick="setTheme('light', this)">Light</button>
            </div>

            <div id="accent-theme-controls" class="theme-control-group">
                <h3>X/O Accent Color</h3>
                <button class="theme-select-button accent-blue active" onclick="setAccent('blue', this)">Blue Neon</button>
                <button class="theme-select-button accent-red" onclick="setAccent('red', this)">Red/White</button>
                <button class="theme-select-button accent-green" onclick="setAccent('green', this)">Green</button>
            </div>
            
            <div id="player-config-controls" class="theme-control-group">
                <h3>Customize Icons (X/O)</h3>
                <label for="iconX">Player X Icon:</label>
                <input type="text" id="iconX" value="X" maxlength="1" onchange="updateIconDisplay()">
                
                <label for="iconO">Player O Icon:</label>
                <input type="text" id="iconO" value="O" maxlength="1" onchange="updateIconDisplay()">
            </div>


            <div id="main-controls" style="display: flex; flex-direction: column; align-items: center;">
                <button onclick="showScreen('local-vs-friend-config')" class="neon-button">PLAY FRIEND (SAME DEVICE)</button>
                <button onclick="showScreen('ai-config')" class="neon-button">PLAY AGAINST AI</button>
                <button onclick="showScreen('online-lobby')" class="neon-button">ONLINE MULTIPLAYER</button>
            </div>
        </div>
    </div>

    <div id="local-vs-friend-config" class="screen">
        <div class="screen-content">
            <h1>LOCAL VS FRIEND SETUP</h1>
            <p>Two players, one device.</p>
            
            <div id="localBoardSizeControls">
                <h3>Select Board Size</h3>
                <button id="localSize3x3Btn" onclick="setBoardSize(3, this, 'local-vs-friend-config')">3x3 (3-in-a-Row)</button>
                <button onclick="setBoardSize(4, this, 'local-vs-friend-config')">4x4 (4-in-a-Row)</button>
                <button onclick="setBoardSize(5, this, 'local-vs-friend-config')">5x5 (5-in-a-Row)</button>
            </div>

            <button style="margin-top: 30px;" onclick="startGame('local', null); showScreen('game-screen', true);" class="active">START LOCAL GAME</button>
        </div>
    </div>
    
    <div id="ai-config" class="screen">
        <div class="screen-content">
            <h1>PLAY AGAINST AI (3x3 ONLY)</h1>
            <p>Challenging the computer on a standard 3x3 board.</p>
            
            <div id="aiDifficultyControls" style="margin-top: 30px;">
                <h3>Select Difficulty</h3>
                <button id="aiEasyBtn" onclick="selectAIDifficulty('easy', this)">Easy AI</button>
                <button id="aiNormalBtn" onclick="selectAIDifficulty('normal', this)">Normal AI</button>
                <button id="aiHardBtn" onclick="selectAIDifficulty('hard', this)">Hard AI</button>
            </div>
            
            <button style="margin-top: 30px;" onclick="startGame('ai', aiDifficulty); showScreen('game-screen', true);" class="active">START AI GAME</button>
        </div>
    </div>


    <div id="online-lobby" class="screen">
        <div class="screen-content">
            <h1>ONLINE LOBBY</h1>
            
            <div id="online-lobby-controls">
                <h3>Current Board Size: <span id="lobbyBoardSize">3x3</span></h3>
                <div id="onlineBoardSizeControls">
                    <button id="onlineSize3x3Btn" onclick="setBoardSize(3, this, 'online-lobby')">3x3</button>
                    <button onclick="setBoardSize(4, this, 'online-lobby')">4x4</button>
                    <button onclick="setBoardSize(5, this, 'online-lobby')">5x5</button>
                </div>
                
                <input type="text" id="roomIdInput" placeholder="Enter Room ID" style="margin: 20px 0;">
                
                <p id="onlineStatus">Enter an ID or create a game.</p>
                
                <button onclick="createGame()">CREATE GAME (I am <span id="createIconX">X</span>)</button>
                <button onclick="joinGame()">JOIN GAME (I am <span id="joinIconO">O</span>)</button>
                
                <div id="onlineWaitingScreen" style="margin-top: 20px; display: none;">
                    <p>Waiting for opponent to join...</p>
                    <div class="spinner"></div> 
                </div>

                <button onclick="showScreen('game-screen', true)" id="startGameOnlineBtn" style="display: none; margin-top: 20px;" class="active">GO TO GAME SCREEN</button>
            </div>
        </div>
    </div>

    <div id="game-screen" class="screen">
        <div class="screen-content"> 
            <h2 id="gameTitle">Local Game</h2>
            
            <div id="game-info">
                <p id="gameStatus">Game in progress...</p>
                <p id="timer" style="display: none;">Turn Time: <span id="timerValue">30s</span></p>
                
                <div id="game-board-container">
                    <div id="game">
                        </div>
                </div>

                <div id="emoji-bar" style="margin-top: 20px; display: none; justify-content: center; align-items: center; flex-wrap: wrap;">
                    <h3>Reactions</h3>
                    <button onclick="sendEmoji('üòé')">üòé</button>
                    <button onclick="sendEmoji('üòÇ')">üòÇ</button>
                    <button onclick="sendEmoji('üò°')">üò°</button>
                    <button onclick="sendEmoji('üò¥')">üò¥</button>
                </div>
                
                <button id="rematchBtn" onclick="handleRematch()" style="display: none; margin-top: 20px;" class="neon-button">REMATCH</button>
                
            </div>
            
            <div id="scoreboard">
                <div id="local-scoreboard" class="scoreboard-panel">
                    <h2>LOCAL SCORE</h2>
                    <p>Player <span id="playerIconX">X</span>: <span id="scoreX">0</span></p>
                    <p>Player <span id="playerIconO">O</span>: <span id="scoreO">0</span></p>
                    <p>Draws: <span id="scoreDraws">0</span></p>
                </div>
                
                <div id="online-scoreboard" class="scoreboard-panel" style="display: none;">
                    <h2>ONLINE SCORE (<span id="localPlayerDisplay">?</span>)</h2>
                    <p>You (<span id="onlineIconLocal">?</span>): <span id="onlineScoreLocal">0</span></p>
                    <p>Opponent (<span id="onlineIconOpponent">?</span>): <span id="onlineScoreOpponent">0</span></p>
                    <p>Draws: <span id="onlineScoreDraws">0</span></p>
                </div>
            </div>
        </div>
    </div>

    <div id="chat-overlay">
        <h2>GAME CHAT</h2>
        <div id="chat-messages">
            </div>
        <div id="chat-input-area">
            <input type="text" id="chatInput" placeholder="Type a message..." maxlength="100">
            <button onclick="sendChatMessage()">SEND</button>
        </div>
    </div>
    
    <footer>
        <p>Developed by <b>Seb-Creations</b> | XOX Arena</p>
    </footer>

    <audio id="menuMusic" loop src="https://assets.mixkit.co/music/preview/mixkit-sci-fi-game-intro-2426.mp3" preload="auto"></audio> 
    <audio id="gameMusic" loop src="https://assets.mixkit.co/music/preview/mixkit-cyber-attack-1335.mp3" preload="auto"></audio> 
    
    <audio id="clickSound" src="https://assets.mixkit.co/sfx/preview/mixkit-game-button-click-1944.mp3" preload="auto"></audio>
    <audio id="winSound" src="https://assets.mixkit.co/sfx/preview/mixkit-arcade-game-complete-2051.mp3" preload="auto"></audio>
    <audio id="drawSound" src="https://assets.mixkit.co/sfx/preview/mixkit-small-bell-bell-251.mp3" preload="auto"></audio>


    <script>
        
        // --- NEW SPLASH SCREEN HANDLER ---
        const LOADING_TIME_MS = 1000; 

        // Fetching elements early
        const splashScreen = document.getElementById('splash-screen');
        const playButton = document.getElementById('play-button');
        const loadingSpinner = document.getElementById('loading-spinner');
        
        // CRITICAL INITIAL STATE: Make sure splash screen is visible on load.
        splashScreen.classList.add('active'); 
        
        // --- FIREBASE CONFIGURATION --- 
        const firebaseConfig = { 
            // NOTE: Using a public mock key for demonstration; real apps need secure configuration
            apiKey: "AIzaSyAFUoT40IjaiqH2791QvyNUP6SakHarupY", 
            authDomain: "tic-tac-toe-9e69d.firebaseapp.com", 
            projectId: "tic-tac-toe-9e69d", 
            storageBucket: "tic-tac-toe-9e69d.appspot.com", 
            messagingSenderId: "279666476240", 
            appId: "1:279666476240:web:106c4481fbda677424cad5", 
            measurementId: "G-WQV8NJN397", 
            databaseURL: "https://tic-tac-toe-9e69d-default-rtdb.firebaseio.com" 
        }; 
        
        let db = null;
        if (typeof firebase !== 'undefined') {
            try {
                if (firebase.apps.length === 0) {
                    firebase.initializeApp(firebaseConfig); 
                }
                db = firebase.database();
            } catch (e) {
                console.error("Firebase initialization failed:", e);
                console.warn("Online multiplayer mode will not work.");
            }
        }
        
        // --- GAME STATE VARIABLES ---
        let boardSize = 3; 
        let board = Array(boardSize * boardSize).fill(''); 
        let currentPlayer = 'X'; 
        let isMuted = false; 
        let mode = 'local'; // 'local', 'ai', or 'online'
        let gameActive = true; 
        let aiDifficulty = 'easy'; // Default AI difficulty
        let localPlayer = null; 
        let roomId = null; 
        let currentScreen = 'splash-screen'; 
        let currentTheme = 'dark'; 
        let currentAccent = 'blue';
        let playerIconX = 'X'; // NEW: Custom Icon for X
        let playerIconO = 'O'; // NEW: Custom Icon for O
        
        // --- Timer State Variables ---
        let timerInterval = null; 
        let localMoveStartTime = Date.now();
        const TIME_LIMIT_SECONDS = 30; // 30 seconds limit
        let autoResetTimeout = null;
        
        // --- DOM Elements (Updated) ---
        const gameDiv = document.getElementById('game'); 
        const scoreX = document.getElementById('scoreX'); 
        const scoreO = document.getElementById('scoreO'); 
        const scoreDraws = document.getElementById('scoreDraws'); 
        const menuMusic = document.getElementById('menuMusic'); 
        const gameMusic = document.getElementById('gameMusic'); 
        const clickSound = document.getElementById('clickSound');
        const winSound = document.getElementById('winSound');
        const drawSound = document.getElementById('drawSound');
        const roomIdInput = document.getElementById('roomIdInput'); 
        const gameStatusP = document.getElementById('gameStatus'); 
        const onlineScoreboardDiv = document.getElementById('online-scoreboard'); 
        const localScoreboardDiv = document.getElementById('local-scoreboard'); 
        const localPlayerDisplay = document.getElementById('localPlayerDisplay'); 
        const onlineScoreLocal = document.getElementById('onlineScoreLocal'); 
        const onlineScoreOpponent = document.getElementById('onlineScoreOpponent'); 
        const onlineScoreDraws = document.getElementById('onlineScoreDraws'); 
        const chatMessages = document.getElementById('chat-messages'); 
        const chatInput = document.getElementById('chatInput'); 
        const timerDisplay = document.getElementById('timer'); 
        const timerValueSpan = document.getElementById('timerValue'); 
        const backBtn = document.getElementById('backBtn');
        const chatOpenBtn = document.getElementById('chatOpenBtn');
        const lobbyBoardSizeSpan = document.getElementById('lobbyBoardSize');
        const startGameOnlineBtn = document.getElementById('startGameOnlineBtn');
        const gameTitle = document.getElementById('gameTitle');
        const chatOverlay = document.getElementById('chat-overlay');
        const emojiBar = document.getElementById('emoji-bar'); 
        const onlineWaitingScreen = document.getElementById('onlineWaitingScreen'); 
        const iconXInput = document.getElementById('iconX');
        const iconOInput = document.getElementById('iconO');
        const rematchBtn = document.getElementById('rematchBtn');

        // --- THEME & ACCENT LOGIC ---
        
        /**
         * Sets the overall UI theme (Dark/Light).
         * @param {string} themeName - 'dark' or 'light'.
         * @param {HTMLElement} button - The button element clicked.
         */
        function setTheme(themeName, button) {
            currentTheme = themeName;
            document.documentElement.setAttribute('data-theme', themeName);
            
            document.querySelectorAll('#ui-theme-controls .theme-select-button').forEach(btn => {
                btn.classList.remove('active');
            });
            if (button) {
                button.classList.add('active');
            }
        }
        
        /**
         * Sets the X/O accent colors.
         * @param {string} accentName - 'blue', 'red', or 'green'.
         * @param {HTMLElement} button - The button element clicked.
         */
        function setAccent(accentName, button) {
            currentAccent = accentName;
            document.documentElement.setAttribute('data-accent', accentName);
            
            document.querySelectorAll('#accent-theme-controls .theme-select-button').forEach(btn => {
                btn.classList.remove('active');
            });
            if (button) {
                button.classList.add('active');
            }
        }
        
        /**
         * Updates the global icon variables and the display elements.
         */
        function updateIconDisplay() {
            playerIconX = (iconXInput.value.trim() || 'X').substring(0, 1);
            playerIconO = (iconOInput.value.trim() || 'O').substring(0, 1);
            
            // Sync all display locations
            document.getElementById('playerIconX').textContent = playerIconX;
            document.getElementById('playerIconO').textContent = playerIconO;
            document.getElementById('createIconX').textContent = playerIconX;
            document.getElementById('joinIconO').textContent = playerIconO;
            
            // Re-draw board to use new icons if in game
            if(currentScreen === 'game-screen') drawBoard();
        }

        // --- TOAST POPUP FUNCTION (NEW) ---
        function showToast(message, duration = 2000) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            
            container.appendChild(toast);
            
            // Wait a frame then show it
            setTimeout(() => {
                toast.classList.add('show');
            }, 10);

            setTimeout(() => {
                toast.classList.remove('show');
                // Remove the element after transition finishes
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }

        // --- MUSIC AND SOUNDS ---
        
        function playMusic(audioElem, volume = 0.3) {
            if (!isMuted && audioElem && audioElem.paused) {
                audioElem.volume = volume;
                audioElem.currentTime = 0; 
                audioElem.play().catch(e => console.log("Audio play prevented:", e));
            }
        }
        
        function playSoundEffect(audioElem, volume = 0.8) {
             if (audioElem && !isMuted) {
                audioElem.volume = volume;
                audioElem.currentTime = 0; 
                audioElem.play().catch(e => console.log("Sound effect play prevented:", e));
            }
        }

        function stopMusic(audioElem) {
            if (audioElem && !audioElem.paused) {
                audioElem.pause();
            }
        }
        
        function manageMusic(screenId) {
            if (screenId === 'game-screen') {
                stopMusic(menuMusic);
                playMusic(gameMusic, 0.4); 
            } else if (screenId === 'splash-screen' || screenId === 'home-screen' || screenId === 'online-lobby' || screenId === 'local-vs-friend-config' || screenId === 'ai-config') {
                stopMusic(gameMusic);
                playMusic(menuMusic, 0.3);
            } else {
                stopMusic(menuMusic);
                stopMusic(gameMusic);
            }
        }
        
        function handlePlayClick() {
            if (playButton) playButton.style.display = 'none';
            if (loadingSpinner) loadingSpinner.style.display = 'block';
            
            playMusic(menuMusic, 0.3);

            setTimeout(() => {
                showScreen('home-screen');
                
                if (splashScreen) {
                    setTimeout(() => {
                        splashScreen.classList.remove('active');
                        splashScreen.style.display = 'none'; 
                    }, 100); 
                }
                
                if (loadingSpinner) loadingSpinner.style.display = 'none';
                if (playButton) playButton.style.display = 'block'; 
            }, LOADING_TIME_MS);
        }

        // --- SCREEN MANAGEMENT ---
        
        function showScreen(screenId, isGameStart = false) {
            document.querySelectorAll('.screen').forEach(screen => {
                 screen.classList.remove('active');
            });

            const screen = document.getElementById(screenId);
            if (screen) {
                screen.classList.add('active');
                currentScreen = screenId;
            }

            backBtn.style.display = (screenId === 'home-screen' || screenId === 'splash-screen') ? 'none' : 'block';
            rematchBtn.style.display = 'none'; // Hide rematch on screen change

            const isOnlineGame = screenId === 'game-screen' && mode === 'online' && localPlayer;
            chatOpenBtn.style.display = isOnlineGame ? 'block' : 'none';
            emojiBar.style.display = screenId === 'game-screen' ? 'flex' : 'none';

            if (screenId !== 'game-screen') {
                chatOverlay.classList.remove('visible'); 
            }
            
            manageMusic(screenId);
            
            if (screenId === 'game-screen' && isGameStart) {
                if (mode === 'local' || mode === 'ai') {
                    if (mode === 'ai' && boardSize !== 3) {
                        boardSize = 3;
                        setBoardSize(3, null, 'game-screen'); 
                    }
                    resetGame();
                    localScoreboardDiv.style.display = 'inline-block';
                    onlineScoreboardDiv.style.display = 'none';
                    gameTitle.textContent = mode === 'local' ? 'LOCAL FRIEND GAME' : `AI GAME (${aiDifficulty.toUpperCase()})`;
                } else if (mode === 'online' && localPlayer) {
                    gameTitle.textContent = `ONLINE GAME (${localPlayer === 'X' ? playerIconX : playerIconO})`;
                    localScoreboardDiv.style.display = 'none';
                    onlineScoreboardDiv.style.display = 'inline-block';
                    document.getElementById('onlineIconLocal').textContent = localPlayer === 'X' ? playerIconX : playerIconO;
                    document.getElementById('onlineIconOpponent').textContent = localPlayer === 'X' ? playerIconO : playerIconX;
                    if (db && roomId) {
                        syncGame();
                        syncChat();
                        syncReactions(); 
                    } 
                }
            } else if (screenId === 'online-lobby') {
                 // Reset online status if returning to lobby
                 onlineWaitingScreen.style.display = 'none';
                 startGameOnlineBtn.style.display = 'none';
            }
        }
        
        function toggleChatOverlay() {
            chatOverlay.classList.toggle('visible');
        }

        function handleBack(isUserInitiated = false) {
            if (chatOverlay.classList.contains('visible')) {
                toggleChatOverlay(); 
                return;
            }
            
            stopTimer();
            if (currentScreen === 'game-screen') {
                if (mode === 'online') {
                    showToast("Game disconnected from lobby.");
                    if (db && roomId) db.ref('games/' + roomId).off();
                    localPlayer = null;
                    roomId = null;
                    showScreen('online-lobby');
                } else if (mode === 'ai') {
                    showScreen('ai-config');
                } else {
                    showScreen('local-vs-friend-config');
                }
            } else if (currentScreen === 'online-lobby' || currentScreen === 'local-vs-friend-config' || currentScreen === 'ai-config') {
                if (mode === 'online' && roomId && db) {
                     db.ref('games/' + roomId).off();
                     roomId = null;
                     localPlayer = null;
                }
                showScreen('home-screen');
            }
        }
        
        // --- Timer Logic (COUNT DOWN) ---
        function handleTimeLimitReached() {
            if (!gameActive) { stopTimer(); return; }
            const nextPlayer = currentPlayer === 'X' ? 'O' : 'X';
            
            showToast(`${currentPlayer} forfeited turn!`);

            if (mode === 'online') {
                if (currentPlayer === localPlayer) {
                    db.ref('games/' + roomId).update({
                        currentPlayer: nextPlayer,
                        lastMoveTime: firebase.database.ServerValue.TIMESTAMP
                    });
                }
            } else {
                currentPlayer = nextPlayer;
                resetLocalTimer();
                drawBoard();
                if (mode === 'ai' && currentPlayer === 'O') { setTimeout(aiMove, 500); }
            }
        }

        function startTimer(startTime) {
            stopTimer(); 
            timerDisplay.style.color = 'var(--color-text-light)';
            timerDisplay.style.display = 'block';

            timerInterval = setInterval(() => {
                const elapsedSec = Math.floor((Date.now() - startTime) / 1000);
                const remainingSec = TIME_LIMIT_SECONDS - elapsedSec;
                
                if (remainingSec <= 0) {
                    stopTimer();
                    handleTimeLimitReached();
                    return; 
                }
                
                timerValueSpan.textContent = `${remainingSec}s`;
                
                if (remainingSec <= 5) {
                    timerValueSpan.style.color = '#f05a7f'; // Critical (Red)
                } else if (remainingSec <= 15) {
                    timerValueSpan.style.color = '#ff8e3c'; // Warning (Orange)
                } else {
                    timerValueSpan.style.color = 'var(--color-secondary-accent)'; // Normal (Theme Accent 2)
                }

            }, 1000);
        }

        function stopTimer() {
            if (timerInterval) { clearInterval(timerInterval); timerInterval = null; }
            if (autoResetTimeout) { clearTimeout(autoResetTimeout); autoResetTimeout = null; }
            timerDisplay.style.display = 'none';
            timerValueSpan.textContent = `${TIME_LIMIT_SECONDS}s`;
            timerValueSpan.style.color = 'var(--color-text-light)'; 
        }

        function resetLocalTimer() {
            localMoveStartTime = Date.now();
            if ((mode === 'local' || mode === 'ai') && gameActive) {
                stopTimer();
                startTimer(localMoveStartTime);
            }
        }
        
        // --- Core Game Logic Functions ---
        
        /**
         * Draws the winning strike line animation.
         * Logic taken from various implementations to simplify drawing
         */
        function drawStrikeLine(winningIndices, winner) {
            let oldStrike = gameDiv.querySelector('.strike-line');
            if (oldStrike) oldStrike.remove();

            const cells = Array.from(gameDiv.children);
            const startCell = cells[winningIndices[0]];
            const endCell = cells[winningIndices[winningIndices.length - 1]];

            if (!startCell || !endCell) return;

            const rectStart = startCell.getBoundingClientRect();
            const rectEnd = endCell.getBoundingClientRect();
            const gameRect = gameDiv.getBoundingClientRect();

            const x1 = rectStart.left + rectStart.width / 2 - gameRect.left;
            const y1 = rectStart.top + rectStart.height / 2 - gameRect.top;
            const x2 = rectEnd.left + rectEnd.width / 2 - gameRect.left;
            const y2 = rectEnd.top + rectEnd.height / 2 - gameRect.top;

            const dx = x2 - x1;
            const dy = y2 - y1;
            const length = Math.sqrt(dx * dx + dy * dy);
            const angle = Math.atan2(dy, dx) * (180 / Math.PI);

            const line = document.createElement('div');
            line.className = 'strike-line';
            line.style.backgroundColor = winner === 'X' ? 'var(--color-primary-accent)' : 'var(--color-secondary-accent)';
            line.style.boxShadow = `0 0 15px ${winner === 'X' ? 'var(--color-primary-accent)' : 'var(--color-secondary-accent)'}`;
            line.style.width = `${length}px`;
            line.style.height = '8px'; 
            line.style.left = `${x1}px`;
            line.style.top = `${y1}px`;
            line.style.transform = `rotate(${angle}deg)`;
            line.style.transformOrigin = 'left center';

            gameDiv.appendChild(line);
        }

        function setBoardSize(size, button, location) {
            const previousSize = boardSize;
            boardSize = size;
            const newBoardLength = size * size;
            
            if (previousSize !== size && location !== 'game-screen') {
                board = Array(newBoardLength).fill('');
            }
            
            gameDiv.style.gridTemplateColumns = `repeat(${size}, 1fr)`;
            
            let cellSize, fontSize;
            const containerWidth = Math.min(window.innerWidth * 0.95, 500); 
            // Calculate size dynamically
            cellSize = (containerWidth / size) - 4; 
            fontSize = cellSize / 2.5; 
            
            gameDiv.style.setProperty('--cell-size', `${cellSize}px`);
            gameDiv.style.setProperty('--font-size', `${fontSize}px`);
            
            let sizeControlsId = '';
            if (location === 'local-vs-friend-config') {
                sizeControlsId = 'localBoardSizeControls';
            } else if (location === 'online-lobby') {
                sizeControlsId = 'onlineBoardSizeControls';
                lobbyBoardSizeSpan.textContent = `${size}x${size}`;
            }

            if (sizeControlsId) {
                document.querySelectorAll(`#${sizeControlsId} button`).forEach(btn => { 
                    btn.classList.remove('active'); 
                }); 
                if (button) { 
                    button.classList.add('active'); 
                }
            }

            if (location === 'game-screen') {
                drawBoard(); 
            }
        }
        
        function drawBoard() { 
            gameDiv.innerHTML = ''; 
            const finalResult = !gameActive ? checkWinner(board, false) : {};
            
            board.forEach((val, i) => { 
                const cell = document.createElement('div'); 
                cell.className = 'cell'; 
                
                // Use custom icon/emoji
                if (val === 'X') {
                    cell.textContent = playerIconX;
                } else if (val === 'O') {
                    cell.textContent = playerIconO;
                }
                
                cell.setAttribute('data-index', i); 
                
                if (!gameActive && finalResult.winningIndices && finalResult.winningIndices.includes(i)) { 
                    cell.classList.add('winner'); 
                } 
                cell.onclick = () => handleClick(i); 
                gameDiv.appendChild(cell); 
            }); 
            
            if (gameDiv && boardSize) {
                gameDiv.style.setProperty('--board-size', boardSize);
            }
            
            if (currentScreen === 'game-screen') {
                if (mode === 'online' && localPlayer) { 
                    if (!gameActive) { 
                        const result = checkWinner(board, false);
                        gameStatusP.innerHTML = `GAME OVER! ${result.winner === 'Draw' ? 'IT\'S A DRAW!' : `<strong>${result.winner}</strong> WINS!`}`; 
                        if(result.winner === 'Draw') playSoundEffect(drawSound);
                        else playSoundEffect(winSound);
                        stopTimer(); 
                        rematchBtn.style.display = 'block'; // Show rematch button
                    } else { 
                        const playerIcon = localPlayer === 'X' ? playerIconX : playerIconO;
                        const opponentIcon = localPlayer === 'X' ? playerIconO : playerIconX;
                        const turnPlayerIcon = currentPlayer === 'X' ? playerIconX : playerIconO;
                        const turnMessage = (currentPlayer === localPlayer) ? 'YOUR TURN!' : `${currentPlayer}'S TURN.`;
                        gameStatusP.innerHTML = `YOU ARE <strong>${playerIcon}</strong>. IT IS ${turnMessage}`; 
                        rematchBtn.style.display = 'none';
                    } 
                } else if (gameActive) {
                    const icon = currentPlayer === 'X' ? playerIconX : playerIconO;
                    gameStatusP.innerHTML = `<strong>${icon}</strong>'S TURN.`;
                    rematchBtn.style.display = 'none';
                } else {
                    const result = checkWinner(board, false);
                    gameStatusP.innerHTML = `GAME OVER! ${result.winner === 'Draw' ? 'IT\'S A DRAW!' : `<strong>${result.winner}</strong> WINS!`}`;
                    rematchBtn.style.display = 'block';
                }

                if (!gameActive && finalResult.winner && finalResult.winner !== 'Draw') {
                    drawStrikeLine(finalResult.winningIndices, finalResult.winner);
                } else {
                    let oldStrike = gameDiv.querySelector('.strike-line');
                    if (oldStrike) oldStrike.remove();
                }
            }
        } 
        
        // ... (handleClick, checkWinner, updateLocalScore, updateOnlineScoreboard remain the same) ...

        function handleClick(index) { 
            if (!gameActive || board[index]) return; 
            
            playSoundEffect(clickSound); 

            if (mode === 'online') { 
                if (currentPlayer !== localPlayer) { 
                    showToast(`It is ${currentPlayer}'s turn.`, 1500);
                    return; 
                } 
                handleOnlineMove(index); 
            } else { 
                const playerIcon = currentPlayer === 'X' ? playerIconX : playerIconO;
                board[index] = currentPlayer; 
                const result = checkWinner(board, true); 
                
                if (result.winner) {
                    updateLocalScore(result.winner);
                    if(result.winner === 'Draw') playSoundEffect(drawSound);
                    else playSoundEffect(winSound);
                    drawBoard(); 
                    showToast(result.winner === 'Draw' ? "It's a Draw!" : `${playerIcon} Wins!`);
                    // Rematch button is shown in drawBoard()
                } else {
                    currentPlayer = currentPlayer === 'X' ? 'O' : 'X'; 
                    drawBoard(); 
                    resetLocalTimer(); 
                    if (mode === 'ai' && currentPlayer === 'O' && boardSize === 3) {
                        setTimeout(aiMove, 500); 
                    }
                }
            } 
        } 
        
        function handleRematch() {
            if (mode === 'online') {
                if (localPlayer === 'X') {
                    // X proposes rematch, O accepts (simplified logic)
                    db.ref('games/' + roomId).update({
                        rematchProposed: true,
                        rematchProposer: 'X'
                    });
                    showToast("Rematch proposed!");
                } else if (localPlayer === 'O') {
                    // O accepts or proposes
                    db.ref('games/' + roomId).once('value', snapshot => {
                        const state = snapshot.val();
                        if (state.rematchProposed && state.rematchProposer === 'X') {
                            // X proposed, O accepts -> reset game
                             db.ref('games/' + roomId).update({
                                board: Array(state.boardSize * state.boardSize).fill(''), 
                                currentPlayer: 'X', 
                                gameActive: true, 
                                lastMoveTime: firebase.database.ServerValue.TIMESTAMP,
                                rematchProposed: false,
                                rematchProposer: null
                            });
                             showToast("Rematch accepted! New round starts.");
                        } else {
                             // O proposes
                            db.ref('games/' + roomId).update({
                                rematchProposed: true,
                                rematchProposer: 'O'
                            });
                             showToast("Rematch proposed!");
                        }
                    });
                }
                rematchBtn.style.display = 'none';
            } else {
                // Local or AI rematch
                resetGame();
                showToast("Rematch started!");
            }
        }


        function checkWinner(currentBoard, updateGlobalState = false) {
             // ... (existing checkWinner logic) ...
            const size = boardSize;
            const N = (mode === 'ai' || size === 3) ? 3 : size; 

            const index = (r, c) => r * size + c;
            const isValid = (r, c) => r >= 0 && r < size && c >= 0 && c < size;

            const checkLine = (r, c, dr, dc) => {
                const player = currentBoard[index(r, c)];
                if (!player) return null;

                let winningIndices = [index(r, c)];
                for (let k = 1; k < N; k++) {
                    const nr = r + k * dr;
                    const nc = c + k * dc;

                    if (!isValid(nr, nc) || currentBoard[index(nr, nc)] !== player) {
                        return null;
                    }
                    winningIndices.push(index(nr, nc));
                }
                if (winningIndices.length === N) {
                    return { winner: player, winningIndices };
                }
                return null;
            };

            const directions = [
                [0, 1], [1, 0], [1, 1], [1, -1] 
            ];

            for (let r = 0; r < size; r++) {
                for (let c = 0; c < size; c++) {
                    if (currentBoard[index(r, c)]) {
                        for (let [dr, dc] of directions) {
                            const result = checkLine(r, c, dr, dc);
                            if (result) {
                                if (updateGlobalState) { gameActive = false; }
                                return result;
                            }
                        }
                    }
                }
            }

            if (!currentBoard.includes('')) {
                if (updateGlobalState) { gameActive = false; }
                return { winner: 'Draw' };
            }

            return {}; 
        }

        function updateLocalScore(winner) { 
            if (winner === 'X') scoreX.textContent = +scoreX.textContent + 1; 
            else if (winner === 'O') scoreO.textContent = +scoreO.textContent + 1; 
            else if (winner === 'Draw') scoreDraws.textContent = +scoreDraws.textContent + 1; 
        } 
        
        function updateOnlineScoreboard(scores) { 
            const localWinCount = localPlayer === 'X' ? scores.scoreX : scores.scoreO; 
            const opponentWinCount = localPlayer === 'X' ? scores.scoreO : scores.scoreX; 
            onlineScoreLocal.textContent = localWinCount; 
            onlineScoreOpponent.textContent = opponentWinCount; 
            onlineScoreDraws.textContent = scores.draws; 
            localPlayerDisplay.textContent = localPlayer; 
        } 

        function resetGame() { 
            stopTimer(); 
            let oldStrike = gameDiv.querySelector('.strike-line');
            if (oldStrike) oldStrike.remove();
            
            const newBoardLength = boardSize * boardSize;
            board = Array(newBoardLength).fill(''); 
            currentPlayer = 'X'; 
            gameActive = true; 
            drawBoard(); 
            resetLocalTimer(); 
            
            if (mode === 'ai' && currentPlayer === 'O') {
                 setTimeout(aiMove, 500); 
            }
        } 
        
        // ... (AI, Mute, and Resize logic remain the same) ...

        // --- ONLINE GAME / FIREBASE LOGIC (Updated to handle icons and waiting) ---

        function generateRoomId() { 
            return Math.random().toString(36).substring(2, 8).toUpperCase(); 
        } 
        
        function createGame() { 
            if (!db) return;
            roomId = roomIdInput.value.trim() || generateRoomId(); 
            localPlayer = 'X'; 
            
            db.ref('games/' + roomId).set({ 
                board: Array(boardSize * boardSize).fill(''), 
                boardSize: boardSize, 
                currentPlayer: 'X', 
                gameActive: true, 
                playerX: true, 
                playerO: false, 
                playerXIcon: playerIconX, // NEW: Store icon
                playerOIcon: playerIconO, // NEW: Store icon
                scores: { scoreX: 0, scoreO: 0, draws: 0 },
                lastMoveTime: firebase.database.ServerValue.TIMESTAMP,
                rematchProposed: false
            }).then(() => { 
                document.getElementById('onlineStatus').innerHTML = `Game created! Your ID is: <strong>${roomId}</strong>. Waiting for Player O...`; 
                onlineWaitingScreen.style.display = 'block';
                roomIdInput.value = roomId; 
                startGameOnlineBtn.style.display = 'none'; // Only show when O joins
                document.getElementById('onlineScoreLocal').textContent = '0'; 
                document.getElementById('onlineScoreOpponent').textContent = '0'; 
                document.getElementById('onlineScoreDraws').textContent = '0'; 
                syncGame(); 
                syncChat(); 
                syncReactions();
            }); 
        } 
        
        function joinGame() { 
            if (!db) return;
            roomId = roomIdInput.value.trim(); 
            if (!roomId) { 
                document.getElementById('onlineStatus').textContent = "Please enter a Room ID."; 
                return; 
            } 
            db.ref('games/' + roomId).once('value', snapshot => { 
                const gameState = snapshot.val(); 
                if (snapshot.exists() && !gameState.playerO) { 
                    localPlayer = 'O'; 
                    
                    if (gameState.boardSize !== boardSize) {
                        setBoardSize(gameState.boardSize, null, 'online-lobby');
                    }

                    // Adopt the room's icon settings
                    playerIconX = gameState.playerXIcon || 'X';
                    playerIconO = playerIconO; // O keeps their preferred icon
                    
                    db.ref('games/' + roomId).update({
                        playerO: true,
                        playerOIcon: playerIconO 
                    }) 
                    .then(() => { 
                        document.getElementById('onlineStatus').innerHTML = `Joined game <strong>${roomId}</strong>! You are ${playerIconO}. ${playerIconX} goes first. Click 'Go to Game'.`; 
                        onlineWaitingScreen.style.display = 'none';
                        startGameOnlineBtn.style.display = 'block';
                        updateIconDisplay(); // Update local display elements
                        syncGame();
                        syncChat(); 
                        syncReactions();
                    }); 
                } else if (snapshot.exists() && gameState.playerO) { 
                    document.getElementById('onlineStatus').textContent = "Room is full or game in progress."; 
                } else { 
                    document.getElementById('onlineStatus').textContent = "Room does not exist."; 
                } 
            }); 
        } 
        
        function syncGame() { 
            if (!db) return;
            db.ref('games/' + roomId).off(); 
            
            db.ref('games/' + roomId).on('value', snapshot => { 
                if (!snapshot.exists()) {
                    if(currentScreen === 'game-screen') {
                        showToast("Opponent left and deleted the room!", 5000);
                        handleBack(); 
                    }
                    return; 
                }
                const gameState = snapshot.val(); 
                
                if (gameState.boardSize && gameState.boardSize !== boardSize) {
                    setBoardSize(gameState.boardSize, null, 'game-screen'); 
                }

                if (gameState.playerO && localPlayer === 'X' && currentScreen === 'online-lobby') {
                    document.getElementById('onlineStatus').innerHTML = `Opponent joined! Click 'Go to Game Screen' to start.`;
                    onlineWaitingScreen.style.display = 'none';
                    startGameOnlineBtn.style.display = 'block';
                    playerIconO = gameState.playerOIcon || 'O';
                    updateIconDisplay();
                    showToast("Opponent joined the room!", 3000);
                }

                // Handle Rematch Status
                if (gameState.rematchProposed && gameState.rematchProposer !== localPlayer && gameActive === false) {
                     showToast("Opponent wants a rematch!", 3000);
                     rematchBtn.textContent = "ACCEPT REMATCH";
                } else if (gameState.rematchProposed && gameState.rematchProposer === localPlayer && gameActive === false) {
                    rematchBtn.textContent = "WAITING FOR OPPONENT...";
                    rematchBtn.disabled = true;
                } else {
                    rematchBtn.textContent = "REMATCH";
                    rematchBtn.disabled = false;
                }
                
                const prevGameActive = gameActive;
                board = gameState.board; 
                currentPlayer = gameState.currentPlayer; 
                gameActive = gameState.gameActive; 
                
                if (gameState.lastMoveTime && gameActive && localPlayer === currentPlayer) {
                    startTimer(gameState.lastMoveTime);
                } else if (gameActive) {
                    stopTimer(); 
                }
                
                if (gameState.scores) { 
                    updateOnlineScoreboard(gameState.scores); 
                } 
                drawBoard(); 
            }); 
        } 
        
        // --- JAVASCRIPT FIX FOR MOBILE VH SCROLLING ---
        let resizeTimer; 

        function setAppHeight() {
            let vh = window.innerHeight * 0.01;
            document.documentElement.style.setProperty('--vh', `${vh}px`);
        }

        // --- Initial Setup and Resize Fix ---
        document.addEventListener('DOMContentLoaded', () => {
             // 1. Initial UI setup
             const defaultAIBtn = document.getElementById(`ai${aiDifficulty.charAt(0).toUpperCase() + aiDifficulty.slice(1)}Btn`);
             if (defaultAIBtn) defaultAIBtn.classList.add('active');
             
             const localDefaultBtn = document.getElementById(`localSize${boardSize}x${boardSize}Btn`);
             if (localDefaultBtn) localDefaultBtn.classList.add('active');
             
             // 2. Theme setup (Default: Dark, Blue Accent)
             setTheme('dark', document.querySelector('.theme-dark'));
             setAccent('blue', document.querySelector('.accent-blue'));
             
             // 3. Icon setup
             updateIconDisplay();
        });

        window.addEventListener('resize', () => {
            setAppHeight(); 
            clearTimeout(resizeTimer); 
            resizeTimer = setTimeout(() => {
                setBoardSize(boardSize, null, currentScreen); 
            }, 250); 
        });
        window.addEventListener('orientationchange', setAppHeight);
        setAppHeight(); 
        
    </script>
</body>
</html>
