<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Tic Tac Toe by Seb-Creations</title>
  <style>
    body {
      background: linear-gradient(135deg, #7f5af0, #2cb67d);
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      padding: 0;
      color: white;
      text-align: center;
    }

    h1 {
      margin-top: 20px;
    }

    #game {
      display: grid;
      grid-template-columns: repeat(3, 100px);
      grid-gap: 10px;
      justify-content: center;
      margin: 20px auto;
    }

    .cell {
      width: 100px;
      height: 100px;
      background: #16161a;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2.5rem;
      color: #fffffe;
      border-radius: 10px;
      cursor: pointer;
    }

    .cell.winner {
      background: #2cb67d;
    }

    #controls {
      margin: 20px;
    }

    button {
      padding: 10px 20px;
      margin: 5px;
      border: none;
      background: #fffffe;
      color: #0f0f0f;
      font-weight: bold;
      border-radius: 5px;
      cursor: pointer;
    }

    #scoreboard {
      margin-top: 20px;
    }

    #muteBtn {
      position: absolute;
      top: 10px;
      right: 10px;
    }

    footer {
      margin-top: 40px;
      font-size: 0.9rem;
      color: #94a1b2;
    }
    
    #onlineControls {
        margin-top: 15px;
        padding: 10px;
        background: rgba(0, 0, 0, 0.2);
        border-radius: 8px;
    }
  </style>
</head>
<body>
  <h1>Tic Tac Toe</h1>
  <div id="controls">
    <button onclick="startGame('ai', 'easy')">Play AI (Easy)</button>
    <button onclick="startGame('ai', 'normal')">Play AI (Normal)</button>
    <button onclick="startGame('ai', 'hard')">Play AI (Hard)</button>
    <button onclick="startGame('local')">Play with Friend (Same Device)</button>
    <button onclick="handleOnlineStart()">Online Multiplayer</button>
    <button id="muteBtn" onclick="toggleMute()">ðŸ”Š</button>
  </div>
  
  <div id="onlineControls" style="display: none;">
      <input type="text" id="roomIdInput" placeholder="Enter Room ID" style="padding: 8px; border-radius: 5px; border: none; margin-right: 5px; color: #0f0f0f;"/>
      <button onclick="createGame()">Create Game (I am X)</button>
      <button onclick="joinGame()">Join Game (I am O)</button>
      <p id="gameStatus" style="font-weight: bold; margin-top: 10px;">Select a mode above.</p>
  </div>

  <div id="game"></div>

  <div id="scoreboard">
    <p>Player X: <span id="scoreX">0</span></p>
    <p>Player O: <span id="scoreO">0</span></p>
  </div>

  <footer>Developed by Seb-Creations</footer>

  <audio id="bgMusic" loop autoplay>
    <source src="https://www.bensound.com/bensound-music/bensound-sunny.mp3" type="audio/mp3">
  </audio>

  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <script>
    // --- UPDATED FIREBASE CONFIGURATION ---
    const firebaseConfig = {
      apiKey: "AIzaSyAFUoT40IjaiqH2791QvyNUP6SakHarupY",
      authDomain: "tic-tac-toe-9e69d.firebaseapp.com",
      projectId: "tic-tac-toe-9e69d",
      storageBucket: "tic-tac-toe-9e69d.appspot.com",
      messagingSenderId: "279666476240",
      appId: "1:279666476240:web:106c4481fbda677424cad5",
      measurementId: "G-WQV8NJN397",
      databaseURL: "https://tic-tac-toe-9e69d-default-rtdb.firebaseio.com"
    };
    // -------------------------------------

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let board = Array(9).fill('');
    let currentPlayer = 'X';
    let isMuted = false;
    let mode = 'local';
    let gameActive = true;
    let aiDifficulty = 'easy';
    let localPlayer = null; // 'X' or 'O' for online play
    let roomId = null;      // Current game room ID

    const gameDiv = document.getElementById('game');
    const scoreX = document.getElementById('scoreX');
    const scoreO = document.getElementById('scoreO');
    const bgMusic = document.getElementById('bgMusic');
    const onlineControlsDiv = document.getElementById('onlineControls');
    const roomIdInput = document.getElementById('roomIdInput');
    const gameStatusP = document.getElementById('gameStatus');

    function renderBoard() {
      gameDiv.innerHTML = '';
      board.forEach((val, i) => {
        const cell = document.createElement('div');
        cell.className = 'cell';
        cell.textContent = val;
        // Add win class if present in local state
        if (!gameActive && checkWinner().winningIndices && checkWinner().winningIndices.includes(i)) {
             cell.classList.add('winner');
        }
        cell.onclick = () => handleClick(i);
        gameDiv.appendChild(cell);
      });
      
      // Update status for online play
      if (mode === 'online' && localPlayer) {
          gameStatusP.textContent = gameActive 
            ? `You are ${localPlayer}. It is ${currentPlayer}'s turn.`
            : `Game Over! ${checkWinner().winner || 'Draw'} wins!`;
      } else if (mode === 'online') {
          gameStatusP.textContent = 'Waiting to create or join a game...';
      }
    }

    function handleClick(index) {
      if (!gameActive || board[index]) return;
      
      if (mode === 'online') {
          // ONLINE: Only allow moves if it's the local player's turn
          if (currentPlayer !== localPlayer) {
              gameStatusP.textContent = `It is not your turn (${currentPlayer}'s turn).`;
              return; 
          }
          handleOnlineMove(index);
      } else {
          // LOCAL or AI: Proceed with local logic
          board[index] = currentPlayer;
          renderBoard();
          checkWinner();
          currentPlayer = currentPlayer === 'X' ? 'O' : 'X';
          if (mode === 'ai') aiMove();
      }
    }

    function checkWinner() {
      const wins = [
        [0,1,2], [3,4,5], [6,7,8], // Rows
        [0,3,6], [1,4,7], [2,5,8], // Columns
        [0,4,8], [2,4,6]           // Diagonals
      ];
      
      let winner = null;
      let winningIndices = null;

      for (let [a,b,c] of wins) {
        if (board[a] && board[a] === board[b] && board[a] === board[c]) {
          winner = board[a];
          winningIndices = [a,b,c];
          gameActive = false;
          
          // Only update score/visuals locally if not online
          if (mode !== 'online') {
             document.querySelectorAll('.cell')[a].classList.add('winner');
             document.querySelectorAll('.cell')[b].classList.add('winner');
             document.querySelectorAll('.cell')[c].classList.add('winner');
             updateScore(winner);
             setTimeout(resetGame, 2000);
          }
          return { winner, winningIndices };
        }
      }

      if (!board.includes('')) {
        gameActive = false;
        if (mode !== 'online') {
           setTimeout(resetGame, 2000);
        }
        return { winner: 'Draw' };
      }
      
      return {}; // No winner yet
    }
    
    // Renders the win state after receiving the final board state from the opponent
    function renderWinState(winner, winningIndices) {
        if (winner && winningIndices) {
            document.querySelectorAll('.cell')[winningIndices[0]].classList.add('winner');
            document.querySelectorAll('.cell')[winningIndices[1]].classList.add('winner');
            document.querySelectorAll('.cell')[winningIndices[2]].classList.add('winner');
            updateScore(winner);
        }
    }

    function updateScore(winner) {
      if (winner === 'X') scoreX.textContent = +scoreX.textContent + 1;
      else if (winner === 'O') scoreO.textContent = +scoreO.textContent + 1;
    }

    function resetGame() {
      board = Array(9).fill('');
      currentPlayer = 'X';
      gameActive = true;
      renderBoard();
    }

    function startGame(selectedMode, difficulty = 'easy') {
      mode = selectedMode;
      onlineControlsDiv.style.display = 'none';
      localPlayer = null; // Clear local player on mode change
      roomId = null;      // Clear room ID
      // Stop listening to old Firebase game if active
      db.ref('games/' + roomId).off(); 
      resetGame();
      if (mode === 'ai') aiDifficulty = difficulty;
      gameStatusP.textContent = 'Game started locally or vs AI.';
    }
    
    // --- Online Multiplayer Functions ---
    
    function handleOnlineStart() {
        startGame('online');
        onlineControlsDiv.style.display = 'block';
        gameStatusP.textContent = 'Enter a room ID or generate one.';
    }

    function generateRoomId() {
        return Math.random().toString(36).substring(2, 8).toUpperCase();
    }

    // Function for Player X to create a new game
    function createGame() {
        roomId = roomIdInput.value.trim() || generateRoomId();
        localPlayer = 'X';
        
        // Initialize the game state in Firebase
        db.ref('games/' + roomId).set({
            board: Array(9).fill(''),
            currentPlayer: 'X',
            gameActive: true,
            playerX: true, // X is ready
            playerO: false // Waiting for O
        }).then(() => {
            gameStatusP.textContent = `Game created! Your ID is: ${roomId}. Waiting for Player O...`;
            roomIdInput.value = roomId;
            syncGame();
        }).catch(error => {
            console.error("Firebase error:", error);
            gameStatusP.textContent = "Error creating game. Check console.";
        });
    }

    // Function for Player O to join an existing game
    function joinGame() {
        roomId = roomIdInput.value.trim();
        if (!roomId) {
            gameStatusP.textContent = "Please enter a Room ID.";
            return;
        }
        
        db.ref('games/' + roomId).once('value', snapshot => {
            if (snapshot.exists() && !snapshot.val().playerO) {
                localPlayer = 'O';
                db.ref('games/' + roomId + '/playerO').set(true)
                  .then(() => {
                    gameStatusP.textContent = `Joined game ${roomId}! You are O. X goes first.`;
                    syncGame();
                  });
            } else if (snapshot.exists() && snapshot.val().playerO) {
                gameStatusP.textContent = "Room is full or doesn't exist.";
            } else {
                gameStatusP.textContent = "Room does not exist.";
            }
        });
    }

    // Listens for real-time changes in the Firebase game room
    function syncGame() {
        db.ref('games/' + roomId).on('value', snapshot => {
            if (!snapshot.exists()) return;

            const gameState = snapshot.val();
            
            // Update local state from Firebase
            board = gameState.board;
            currentPlayer = gameState.currentPlayer;
            gameActive = gameState.gameActive;

            renderBoard();

            // Handle win/draw condition received from opponent
            if (!gameActive) {
                const result = checkWinner();
                renderWinState(result.winner, result.winningIndices);
                
                // Offer to reset game after a delay
                if (localPlayer === 'X') { // Only one player handles the reset
                    setTimeout(() => {
                       if (confirm("Game over. Start a new round?")) {
                           db.ref('games/' + roomId).update({
                               board: Array(9).fill(''),
                               currentPlayer: 'X',
                               gameActive: true
                           });
                       } else {
                           db.ref('games/' + roomId).off(); // Stop listening
                       }
                    }, 3000);
                }
            }
        });
    }

    // Updates the board in Firebase after a local move
    function handleOnlineMove(index) {
        board[index] = localPlayer;
        
        // 1. Check for local winner before updating Firebase
        const result = checkWinner(); 
        
        const nextPlayer = localPlayer === 'X' ? 'O' : 'X';
        
        // 2. Update Firebase with the new state
        db.ref('games/' + roomId).update({
            board: board,
            currentPlayer: result.winner ? localPlayer : nextPlayer, // Next player is only set if no winner
            gameActive: result.winner || result.winner === 'Draw' ? false : true
        });
    }
    
    // --- AI Logic (Kept Random for simplicity) ---

    function aiMove() {
      if (!gameActive || currentPlayer !== 'O') return;
      
      let empty = board.map((v, i) => v === '' ? i : null).filter(v => v !== null);
      
      if (empty.length > 0) {
        let move = empty[Math.floor(Math.random() * empty.length)];
        board[move] = 'O';
        renderBoard();
        checkWinner();
        currentPlayer = 'X';
      }
    }

    function toggleMute() {
      isMuted = !isMuted;
      bgMusic.muted = isMuted;
      document.getElementById('muteBtn').textContent = isMuted ? 'ðŸ”‡' : 'ðŸ”Š';
    }

    renderBoard();
  </script>
</body>
</html>
