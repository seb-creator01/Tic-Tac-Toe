<!DOCTYPE html>
<html lang="en">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
Â  Â  <title>XOX ARENA</title>
Â  Â  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&display=swap" rel="stylesheet">
Â  Â  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
Â  Â  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
Â  Â  <style>
Â  Â  Â  Â  /* --- THEME COLORS --- */
Â  Â  Â  Â  :root {
Â  Â  Â  Â  Â  Â  --color-primary-accent: #00bfff; /* Electric Blue */
Â  Â  Â  Â  Â  Â  --color-secondary-accent: #39ff14; /* Neon Green */
Â  Â  Â  Â  Â  Â  --color-dark-bg: #0f0f0f;
Â  Â  Â  Â  Â  Â  --color-panel-bg: #16161a;
Â  Â  Â  Â  Â  Â  --color-text-light: #eeeeee;
Â  Â  Â  Â  Â  Â  --color-text-dark: #0f0f0f;
Â  Â  Â  Â  Â  Â  --color-cell-bg: #242629;
Â  Â  Â  Â  Â  Â  --color-cell-hover: #393e46;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  /* CSS Variable set by JS for reliable mobile viewport height */
Â  Â  Â  Â  Â  Â  --vh: 1vh;
Â  Â  Â  Â  Â  Â  --dynamic-board-size: 300px; /* Default, will be set by JS */
Â  Â  Â  Â  }

Â  Â  Â  Â  /* --- LIGHT THEME --- */
Â  Â  Â  Â  .light-theme {
Â  Â  Â  Â  Â  Â  --color-primary-accent: #1e88e5;Â 
Â  Â  Â  Â  Â  Â  --color-secondary-accent: #ffb300;Â 
Â  Â  Â  Â  Â  Â  --color-dark-bg: #f0f0f0;
Â  Â  Â  Â  Â  Â  --color-panel-bg: #ffffff;
Â  Â  Â  Â  Â  Â  --color-text-light: #333333;
Â  Â  Â  Â  Â  Â  --color-text-dark: #ffffff;
Â  Â  Â  Â  Â  Â  --color-cell-bg: #e0e0e0;
Â  Â  Â  Â  Â  Â  --color-cell-hover: #cfcfcf;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* --- CORE LAYOUT FIX --- */
Â  Â  Â  Â  * {
Â  Â  Â  Â  Â  Â  box-sizing: border-box;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  html, body {
Â  Â  Â  Â  Â  Â  /* CRITICAL FIX 2: Use the JS-calculated variable for reliable mobile height */
Â  Â  Â  Â  Â  Â  height: calc(var(--vh, 1vh) * 100);Â 
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  margin: 0;Â 
Â  Â  Â  Â  Â  Â  padding: 0;Â 
Â  Â  Â  Â  Â  Â  overflow: hidden; /* Prevents global scroll */
Â  Â  Â  Â  Â  Â  font-family: 'Roboto', 'Segoe UI', sans-serif;Â 
Â  Â  Â  Â  Â  Â  background: var(--color-dark-bg);
Â  Â  Â  Â  Â  Â  color: var(--color-text-light);Â 
Â  Â  Â  Â  Â  Â  text-align: center;Â 
Â  Â  Â  Â  Â  Â  display: flex; /* Use flexbox to manage the single column layout */
Â  Â  Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  Â  Â  align-items: center; /* Center content horizontally */
Â  Â  Â  Â  Â  Â  transition: background 0.3s, color 0.3s;Â 
Â  Â  Â  Â  Â  Â  user-select: none;
Â  Â  Â  Â  }Â 
Â  Â  Â  Â Â 
Â  Â  Â  Â  h1, h2, h3 {Â 
Â  Â  Â  Â  Â  Â  font-weight: 900;
Â  Â  Â  Â  Â  Â  color: var(--color-primary-accent);Â 
Â  Â  Â  Â  Â  Â  text-shadow: 0 0 8px rgba(0, 191, 255, 0.5);Â 
Â  Â  Â  Â  Â  Â  margin-top: 10px;
Â  Â  Â  Â  }Â 
Â  Â  Â  Â  h1 { font-size: 2.5rem; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .screen {
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  max-width: 600px;
Â  Â  Â  Â  Â  Â  margin: 0 auto;
Â  Â  Â  Â  Â  Â  display: none;Â 
Â  Â  Â  Â  Â  Â  padding: 0 20px;Â 
Â  Â  Â  Â  Â  Â  box-sizing: border-box;
Â  Â  Â  Â  Â  Â  background: var(--color-dark-bg);Â 
Â  Â  Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  Â  Â  animation: fadeIn 0.3s ease-in-out;
Â  Â  Â  Â  Â  Â  z-index: 100;Â 
Â  Â  Â  Â  Â  Â  overflow-y: auto; /* Allow scrolling for tall menu screens */
Â  Â  Â  Â  Â  Â  flex-grow: 1; /* Allows the screen to take up remaining height */
Â  Â  Â  Â  Â  Â  padding-bottom: 50px; /* Space for the footer */
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .screen.active {Â 
Â  Â  Â  Â  Â  Â  display: flex;Â 
Â  Â  Â  Â  }

Â  Â  Â  Â  /* --- GAME SCREEN SPECIFIC LAYOUT --- */
Â  Â  Â  Â  #game-screen .screen-content {
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  Â  Â  align-items: center;Â 
Â  Â  Â  Â  Â  Â  height: 100%;Â 
Â  Â  Â  Â  Â  Â  padding-top: 10px;Â 
Â  Â  Â  Â  Â  Â  box-sizing: border-box;
Â  Â  Â  Â  Â  Â  overflow-y: hidden; /* Prevent scrolling inside the game area */
Â  Â  Â  Â  }

Â  Â  Â  Â  #game-info-header,
Â  Â  Â  Â  #player-names-display,Â 
Â  Â  Â  Â  #game-info,
Â  Â  Â  Â  #scoreboard,
Â  Â  Â  Â  #post-game-actions {
Â  Â  Â  Â  Â  Â  width: 95%;
Â  Â  Â  Â  Â  Â  max-width: 450px;
Â  Â  Â  Â  Â  Â  margin-bottom: 5px;Â 
Â  Â  Â  Â  Â  Â  flex-shrink: 0; /* Ensures these headers/footers take fixed space */
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* CRITICAL RENDER FIX: BOARD CONTAINER */
Â  Â  Â  Â  #game-board-container {
Â  Â  Â  Â  Â  Â  flex-grow: 1; /* Takes all available remaining height */
Â  Â  Â  Â  Â  Â  min-height: 0;Â 
Â  Â  Â  Â  Â  Â  width: 100%;Â 
Â  Â  Â  Â  Â  Â  max-width: 450px;Â 
Â  Â  Â  Â  Â  Â  display: flex;Â 
Â  Â  Â  Â  Â  Â  justify-content: center;
Â  Â  Â  Â  Â  Â  align-items: center;Â 
Â  Â  Â  Â  Â  Â  overflow: hidden;Â 
Â  Â  Â  Â  Â  Â  margin: 5px 0;Â 
Â  Â  Â  Â  Â  Â  height: 100%;Â 
Â  Â  Â  Â  }

Â  Â  Â  Â  /* --- GAME BOARD (DYNAMIC GRID DEFINITION) --- */
Â  Â  Â  Â  #game {Â 
Â  Â  Â  Â  Â  Â  display: grid;Â 
Â  Â  Â  Â  Â  Â  grid-template-columns: repeat(var(--board-size), 1fr);
Â  Â  Â  Â  Â  Â  grid-gap: 8px;Â 
Â  Â  Â  Â  Â  Â  padding: 10px;
Â  Â  Â  Â  Â  Â  background: var(--color-panel-bg);Â 
Â  Â  Â  Â  Â  Â  border-radius: 12px;
Â  Â  Â  Â  Â  Â  box-shadow: 0 0 15px rgba(0, 0, 0, 0.5), inset 0 0 10px rgba(0, 0, 0, 0.3);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  /* CRITICAL FIX 3: Use JS-set variable for width and enforce square ratio */
Â  Â  Â  Â  Â  Â  width: var(--dynamic-board-size);Â 
Â  Â  Â  Â  Â  Â  aspect-ratio: 1 / 1;Â 
Â  Â  Â  Â  Â  Â  max-width: 450px;Â 
Â  Â  Â  Â  Â  Â  max-height: 100%;Â 
Â  Â  Â  Â  }Â 
Â  Â  Â  Â Â 
Â  Â  Â  Â  .cell {Â 
Â  Â  Â  Â  Â  Â  aspect-ratio: 1 / 1;Â 
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  justify-content: center;
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  Â  Â  font-size: var(--font-size, 3rem);Â 
Â  Â  Â  Â  Â  Â  font-weight: 900;
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  Â  Â  background: var(--color-cell-bg);Â 
Â  Â  Â  Â  Â  Â  color: var(--color-text-light);Â 
Â  Â  Â  Â  Â  Â  border-radius: 5px;
Â  Â  Â  Â  Â  Â  transition: background 0.2s, color 0.2s, box-shadow 0.2s;
Â  Â  Â  Â  }Â 
Â  Â  Â  Â Â 
Â  Â  Â  Â  .cell:hover {Â 
Â  Â  Â  Â  Â  Â  background: var(--color-cell-hover);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .cell.winner {
Â  Â  Â  Â  Â  Â  background: var(--color-primary-accent);
Â  Â  Â  Â  Â  Â  color: var(--color-text-dark);
Â  Â  Â  Â  Â  Â  box-shadow: 0 0 10px var(--color-primary-accent);
Â  Â  Â  Â  }

Â  Â  Â  Â  /* --- BUTTONS & INPUTS (Styling restored) --- */
Â  Â  Â  Â  button {
Â  Â  Â  Â  Â  Â  padding: 10px 20px;
Â  Â  Â  Â  Â  Â  margin: 5px;
Â  Â  Â  Â  Â  Â  border: none;
Â  Â  Â  Â  Â  Â  border-radius: 6px;
Â  Â  Â  Â  Â  Â  font-size: 1rem;
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  Â  Â  background: var(--color-primary-accent);
Â  Â  Â  Â  Â  Â  color: var(--color-text-dark);
Â  Â  Â  Â  Â  Â  font-weight: 700;
Â  Â  Â  Â  Â  Â  transition: background 0.2s, transform 0.1s;
Â  Â  Â  Â  }

Â  Â  Â  Â  button:hover:not(.active) {
Â  Â  Â  Â  Â  Â  background: #008cba;
Â  Â  Â  Â  }

Â  Â  Â  Â  button.active {
Â  Â  Â  Â  Â  Â  background: var(--color-secondary-accent);
Â  Â  Â  Â  Â  Â  color: var(--color-text-dark);
Â  Â  Â  Â  Â  Â  box-shadow: 0 0 10px var(--color-secondary-accent);
Â  Â  Â  Â  }

Â  Â  Â  Â  .neon-button {
Â  Â  Â  Â  Â  Â  background: var(--color-primary-accent);
Â  Â  Â  Â  Â  Â  color: var(--color-text-dark);
Â  Â  Â  Â  Â  Â  box-shadow: 0 0 10px var(--color-primary-accent);
Â  Â  Â  Â  Â  Â  margin: 10px 0;
Â  Â  Â  Â  Â  Â  width: 80%;
Â  Â  Â  Â  Â  Â  max-width: 300px;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .neon-button:hover {
Â  Â  Â  Â  Â  Â  box-shadow: 0 0 20px var(--color-primary-accent);
Â  Â  Â  Â  }

Â  Â  Â  Â  input[type="text"] {
Â  Â  Â  Â  Â  Â  padding: 10px;
Â  Â  Â  Â  Â  Â  margin: 5px;
Â  Â  Â  Â  Â  Â  border: 2px solid var(--color-primary-accent);
Â  Â  Â  Â  Â  Â  border-radius: 6px;
Â  Â  Â  Â  Â  Â  background: var(--color-panel-bg);
Â  Â  Â  Â  Â  Â  color: var(--color-text-light);
Â  Â  Â  Â  Â  Â  font-size: 1rem;
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  max-width: 300px;
Â  Â  Â  Â  Â  Â  box-shadow: 0 0 5px rgba(0, 191, 255, 0.5);
Â  Â  Â  Â  }

Â  Â  Â  Â  /* --- FIXED CONTROLS --- */
Â  Â  Â  Â  .fixed-control {
Â  Â  Â  Â  Â  Â  position: fixed;
Â  Â  Â  Â  Â  Â  z-index: 1000;
Â  Â  Â  Â  Â  Â  padding: 8px 12px;
Â  Â  Â  Â  Â  Â  font-size: 0.9rem;
Â  Â  Â  Â  Â  Â  background: var(--color-panel-bg);
Â  Â  Â  Â  Â  Â  border: 2px solid var(--color-primary-accent);
Â  Â  Â  Â  Â  Â  color: var(--color-text-light);
Â  Â  Â  Â  Â  Â  box-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  #muteBtn { top: 10px; left: 10px; }
Â  Â  Â  Â  #backBtn { top: 10px; right: 80px; display: none; }
Â  Â  Â  Â  #chatOpenBtn { top: 10px; right: 10px; display: none; }

Â  Â  Â  Â  /* --- FOOTER --- */
Â  Â  Â  Â  footer {Â 
Â  Â  Â  Â  Â  Â  position: fixed; /* Fixed position to not disrupt flow */
Â  Â  Â  Â  Â  Â  bottom: 0;Â 
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  max-width: 600px;
Â  Â  Â  Â  Â  Â  padding: 5px 0;
Â  Â  Â  Â  Â  Â  font-size: 0.7rem;Â 
Â  Â  Â  Â  Â  Â  color: #4a4d53;Â 
Â  Â  Â  Â  Â  Â  background: var(--color-panel-bg);
Â  Â  Â  Â  Â  Â  box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.5);
Â  Â  Â  Â  Â  Â  z-index: 1001;Â 
Â  Â  Â  Â  Â  Â  flex-shrink: 0; /* Important for flex layout */
Â  Â  Â  Â  }Â 
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* --- CHAT OVERLAY --- */
Â  Â  Â  Â  #chat-overlay {
Â  Â  Â  Â  Â  Â  position: fixed;
Â  Â  Â  Â  Â  Â  top: 0;
Â  Â  Â  Â  Â  Â  right: 0;
Â  Â  Â  Â  Â  Â  width: 80%;
Â  Â  Â  Â  Â  Â  max-width: 350px;
Â  Â  Â  Â  Â  Â  height: calc(var(--vh, 1vh) * 100); /* Uses stable height */
Â  Â  Â  Â  Â  Â  background: rgba(15, 15, 15, 0.95);Â 
Â  Â  Â  Â  Â  Â  box-shadow: -5px 0 15px rgba(0, 0, 0, 0.5);
Â  Â  Â  Â  Â  Â  transform: translateX(100%);Â 
Â  Â  Â  Â  Â  Â  transition: transform 0.3s ease-in-out;
Â  Â  Â  Â  Â  Â  z-index: 1002;Â 
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  Â  Â  padding-top: 50px;Â 
Â  Â  Â  Â  Â  Â  box-sizing: border-box;
Â  Â  Â  Â  }

Â  Â  Â  Â  #chat-overlay.visible {
Â  Â  Â  Â  Â  Â  transform: translateX(0);Â 
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* --- ANIMATIONS & SPINNER --- */
Â  Â  Â  Â  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

Â  Â  Â  Â  #loading-spinner, #loading-spinner-online {
Â  Â  Â  Â  Â  Â  border: 4px solid var(--color-cell-bg);
Â  Â  Â  Â  Â  Â  border-top: 4px solid var(--color-secondary-accent);
Â  Â  Â  Â  Â  Â  border-radius: 50%;
Â  Â  Â  Â  Â  Â  width: 40px;
Â  Â  Â  Â  Â  Â  height: 40px;
Â  Â  Â  Â  Â  Â  animation: spin 1s linear infinite;
Â  Â  Â  Â  Â  Â  display: none;
Â  Â  Â  Â  Â  Â  margin: 20px auto;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  @keyframes spin {
Â  Â  Â  Â  Â  Â  0% { transform: rotate(0deg); }
Â  Â  Â  Â  Â  Â  100% { transform: rotate(360deg); }
Â  Â  Â  Â  }

Â  Â  Â  Â  /* --- CHAT STYLES --- */
Â  Â  Â  Â  #chat-messages {
Â  Â  Â  Â  Â  Â  flex-grow: 1;
Â  Â  Â  Â  Â  Â  overflow-y: auto;
Â  Â  Â  Â  Â  Â  padding: 10px;
Â  Â  Â  Â  Â  Â  text-align: left;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .chat-message-x { color: var(--color-primary-accent); margin: 5px 0; }
Â  Â  Â  Â  .chat-message-o { color: var(--color-secondary-accent); margin: 5px 0; }
Â  Â  Â  Â  #chat-input-area {
Â  Â  Â  Â  Â  Â  padding: 10px;
Â  Â  Â  Â  Â  Â  flex-shrink: 0;
Â  Â  Â  Â  Â  Â  border-top: 1px solid #333;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  #text-input-group {
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  }
Â  Â  Â  Â  #chatInput {
Â  Â  Â  Â  Â  Â  flex-grow: 1;
Â  Â  Â  Â  Â  Â  margin: 0;
Â  Â  Â  Â  }
Â  Â  Â  Â  .send-btn {
Â  Â  Â  Â  Â  Â  flex-shrink: 0;
Â  Â  Â  Â  Â  Â  padding: 10px;
Â  Â  Â  Â  Â  Â  margin: 0 0 0 5px;
Â  Â  Â  Â  }
Â  Â  Â  Â  #reaction-emojis button {
Â  Â  Â  Â  Â  Â  padding: 5px;
Â  Â  Â  Â  Â  Â  margin: 2px;
Â  Â  Â  Â  Â  Â  font-size: 1.2rem;
Â  Â  Â  Â  Â  Â  background: #242629;
Â  Â  Â  Â  Â  Â  box-shadow: none;
Â  Â  Â  Â  }

Â  Â  </style>
</head>
<body id="app-body">
Â  Â Â 
Â  Â  <button id="muteBtn" onclick="toggleMute()" class="fixed-control">ğŸ”Š</button>
Â  Â  <button id="backBtn" onclick="handleBack(true)" class="fixed-control">â† Back</button>
Â  Â  <button id="chatOpenBtn" onclick="toggleChatOverlay()" class="fixed-control">ğŸ’¬ Chat</button>

Â  Â  <div id="splash-screen" class="screen active">
Â  Â  Â  Â  <div class="screen-content">
Â  Â  Â  Â  Â  Â  <p>Seb Creations Presents</p>
Â  Â  Â  Â  Â  Â  <h1>XOX ARENA</h1>
Â  Â  Â  Â  Â  Â  <p id="tagline">â€œThink Fast. Strike Smart. Rule the Grid.â€</p>
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <button id="play-button" onclick="handlePlayClick()">PLAY GAME</button>
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <div id="loading-spinner"></div>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div id="home-screen" class="screen">
Â  Â  Â  Â  <div class="screen-content">
Â  Â  Â  Â  Â  Â  <h1>XOX ARENA</h1>
Â  Â  Â  Â  Â  Â  <p id="tagline" style="margin-top: 0;">â€œThink Fast. Strike Smart. Rule the Grid.â€</p>
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <div id="theme-controls" style="margin-bottom: 30px;">
Â  Â  Â  Â  Â  Â  Â  Â  <h3>Theme</h3>
Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="setTheme('dark')" class="active">Dark (Neon)</button>
Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="setTheme('light')">Light</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <div id="main-controls" style="display: flex; flex-direction: column; align-items: center; margin-top: 50px;">
Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="showScreen('local-config')" class="neon-button">LOCAL 2-PLAYER</button>
Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="showScreen('ai-config')" class="neon-button">PLAY AI</button>Â 
Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="showScreen('online-lobby')" class="neon-button">ONLINE MULTIPLAYER</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  </div>
Â  Â Â 
Â  Â  <div id="ai-config" class="screen">
Â  Â  Â  Â  <div class="screen-content">
Â  Â  Â  Â  Â  Â  <h1 style="padding-top: 20px;">PLAY AI SETUP</h1>
Â  Â  Â  Â  Â  Â  <p>AI is restricted to 3x3 for balanced play.</p>
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <div id="aiBoardSizeControls">
Â  Â  Â  Â  Â  Â  Â  Â  <h3>Select Board Size</h3>
Â  Â  Â  Â  Â  Â  Â  Â  <button id="aiSize3x3Btn" onclick="setBoardSize(3, this, false, 'ai-config')" class="active">3x3 (3-in-a-Row)</button>
Â  Â  Â  Â  Â  Â  Â  Â  <button disabled>4x4 (N/A)</button>
Â  Â  Â  Â  Â  Â  Â  Â  <button disabled>5x5 (N/A)</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â <input type="text" id="playerNameAIAI" placeholder="Your Name (X)" value="Player X" maxlength="15" style="margin: 20px auto; width: 80%;">

Â  Â  Â  Â  Â  Â  <div id="aiDifficultyControls" style="margin-top: 15px;">
Â  Â  Â  Â  Â  Â  Â  Â  <h3>Select AI Difficulty (O)</h3>
Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="startGame('ai', 'easy', this)">Easy</button>
Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="startGame('ai', 'normal', this)">Normal</button>
Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="startGame('ai', 'hard', this)" class="active">Hard (Minimax)</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <button style="margin-top: 30px; width: 80%;" onclick="showScreen('game-screen', true)" class="active neon-button">START AI GAME</button>
Â  Â  Â  Â  </div>
Â  Â  </div>
Â  Â Â 
Â  Â  <div id="local-config" class="screen">
Â  Â  Â  Â  <div class="screen-content">
Â  Â  Â  Â  Â  Â  <h1 style="padding-top: 20px;">LOCAL 2-PLAYER SETUP</h1>
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <div id="boardSizeControls">
Â  Â  Â  Â  Â  Â  Â  Â  <h3>Select Board Size</h3>
Â  Â  Â  Â  Â  Â  Â  Â  <button id="size3x3Btn" onclick="setBoardSize(3, this)" class="active">3x3 (3-in-a-Row)</button>
Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="setBoardSize(4, this)">4x4 (4-in-a-Row)</button>
Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="setBoardSize(5, this)">5x5 (5-in-a-Row)</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <div id="playerNames" style="display: flex; flex-direction: column; margin: 20px auto; width: 80%; max-width: 350px;">
Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="playerNameX" placeholder="Player X Name" value="Player X" maxlength="15" style="margin-bottom: 10px;">
Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="playerNameO" placeholder="Player O Name" value="Player O" maxlength="15">
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div id="modeControls">
Â  Â  Â  Â  Â  Â  Â  Â  <h3>Select Player Mode</h3>
Â  Â  Â  Â  Â  Â  Â  Â  <button id="localPlayBtn" onclick="startGame('local', null, this)" class="active">Play Friend (Same Device)</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <button style="margin-top: 30px; width: 80%;" onclick="showScreen('game-screen', true)" class="active neon-button">START LOCAL GAME</button>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div id="online-lobby" class="screen">
Â  Â  Â  Â  <div class="screen-content">
Â  Â  Â  Â  Â  Â  <h1 style="padding-top: 20px;">ONLINE LOBBY</h1>
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <div id="online-lobby-controls" style="width: 80%; max-width: 350px; margin: 0 auto;">
Â  Â  Â  Â  Â  Â  Â  Â  <h3>Current Board Size: <span id="lobbyBoardSize">3x3</span></h3>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="onlineBoardSizeControls">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="onlineSize3x3Btn" onclick="setBoardSize(3, this, false, 'online-lobby')" class="active">3x3</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="setBoardSize(4, this, false, 'online-lobby')">4x4</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="setBoardSize(5, this, false, 'online-lobby')">5x5</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="roomIdInput" placeholder="Enter Room ID" style="margin: 20px 0;">
Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="onlinePlayerName" placeholder="Your Name (Max 15 chars)" value="Online Player" maxlength="15" style="margin-bottom: 20px;">
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="createGame()" class="neon-button" style="width: 100%;">CREATE GAME (I am X)</button>
Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="joinGame()" class="neon-button" style="width: 100%;">JOIN GAME (I am O)</button>
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  <div id="online-lobby-status" style="margin-top: 15px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p id="onlineStatus">Enter an ID or create a game.</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="loading-spinner-online" style="margin-top: 10px;"></div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="showScreen('game-screen', true)" id="startGameOnlineBtn" style="display: none; margin-top: 20px; width: 100%;" class="active neon-button">GO TO GAME SCREEN</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div id="game-screen" class="screen">
Â  Â  Â  Â  <div class="screen-content">Â 
Â  Â  Â  Â  Â  Â  <header id="game-info-header" style="width: 100%; max-width: 450px; margin-top: 10px;">
Â  Â  Â  Â  Â  Â  Â  Â  <h2 id="gameTitle">Local Game</h2>Â 
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  <div id="player-names-display">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p id="nameX" style="color: var(--color-primary-accent); display: inline-block; margin-right: 20px;">X: Player X</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p id="nameO" style="color: var(--color-secondary-accent); display: inline-block;">O: Player O</p>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  <div id="game-info">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p id="gameStatus">Game in progress...</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p id="timer">Turn Time: <span id="timerValue">30s</span></p>Â 
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </header>
Â  Â  Â  Â  Â  Â  <div id="game-board-container">
Â  Â  Â  Â  Â  Â  Â  Â  <div id="game">
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <div id="post-game-actions" style="display: none; width: 95%; max-width: 450px;">
Â  Â  Â  Â  Â  Â  Â  Â  <button id="rematchBtn" class="neon-button" style="width: 100%;" onclick="handleRematch()">REMATCH</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <div id="scoreboard" style="width: 95%; max-width: 450px;">Â 
Â  Â  Â  Â  Â  Â  Â  Â  <div id="local-scoreboard" class="scoreboard-panel">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2>LOCAL SCORE</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p><span id="nameScoreX">Player X</span>: <span id="scoreX">0</span></p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p><span id="nameScoreO">Player O</span>: <span id="scoreO">0</span></p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p>Draws: <span id="scoreDraws">0</span></p>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  <div id="online-scoreboard" class="scoreboard-panel" style="display: none;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2>ONLINE SCORE (<span id="localPlayerDisplay">?</span>)</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p>You: <span id="onlineScoreLocal">0</span></p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p>Opponent: <span id="onlineScoreOpponent">0</span></p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p>Draws: <span id="onlineScoreDraws">0</span></p>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div id="chat-overlay">
Â  Â  Â  Â  <h2>GAME CHAT</h2>
Â  Â  Â  Â  <div id="chat-messages">
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div id="chat-input-area">
Â  Â  Â  Â  Â  Â  <div id="reaction-emojis">
Â  Â  Â  Â  Â  Â  Â  Â  Â <button onclick="sendChatMessage('ğŸ˜', true)">ğŸ˜</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â <button onclick="sendChatMessage('ğŸ˜‚', true)">ğŸ˜‚</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â <button onclick="sendChatMessage('ğŸ˜¡', true)">ğŸ˜¡</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â <button onclick="sendChatMessage('ğŸ˜¢', true)">ğŸ˜¢</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div id="text-input-group">
Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="chatInput" placeholder="Type a message..." maxlength="100">
Â  Â  Â  Â  Â  Â  Â  Â  <button class="send-btn" onclick="sendChatMessage()">SEND</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  </div>
Â  Â Â 
Â  Â  <footer>
Â  Â  Â  Â  <p>Developed by <b>Seb-Creations</b> | XOX Arena</p>
Â  Â  </footer>

Â  Â  <audio id="menuMusic" loop src="https://assets.mixkit.co/music/preview/mixkit-sci-fi-game-intro-2426.mp3" preload="auto"></audio>Â 
Â  Â  <audio id="gameMusic" loop src="https://assets.mixkit.co/music/preview/mixkit-cyber-attack-1335.mp3" preload="auto"></audio>Â 
Â  Â  <audio id="clickSound" src="https://assets.mixkit.co/sfx/preview/mixkit-game-button-click-1944.mp3" preload="auto"></audio>
Â  Â  <audio id="winSound" src="https://assets.mixkit.co/sfx/preview/mixkit-arcade-game-complete-2051.mp3" preload="auto"></audio>
Â  Â  <audio id="drawSound" src="https://assets.mixkit.co/sfx/preview/mixkit-small-bell-bell-251.mp3" preload="auto"></audio>


Â  Â  <script>
Â  Â  Â  Â Â 
Â  Â  Â  Â  // --- CRITICAL FIX 1: Fix Mobile Viewport Height (vh) Issues ---
Â  Â  Â  Â  function setViewportHeight() {
Â  Â  Â  Â  Â  Â  let vh = window.innerHeight * 0.01;
Â  Â  Â  Â  Â  Â  document.documentElement.style.setProperty('--vh', `${vh}px`);
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- FIREBASE CONFIGURATION (Unchanged) ---Â 
Â  Â  Â  Â  const firebaseConfig = {Â 
Â  Â  Â  Â  Â  Â  apiKey: "AIzaSyAFUoT40IjaiqH2791QvyNUP6SakHarupY",Â 
Â  Â  Â  Â  Â  Â  authDomain: "tic-tac-toe-9e69d.firebaseapp.com",Â 
Â  Â  Â  Â  Â  Â  projectId: "tic-tac-toe-9e69d",Â 
Â  Â  Â  Â  Â  Â  storageBucket: "tic-tac-toe-9e69d.appspot.com",Â 
Â  Â  Â  Â  Â  Â  messagingSenderId: "279666476240",Â 
Â  Â  Â  Â  Â  Â  appId: "1:279666476240:web:106c4481fbda677424cad5",Â 
Â  Â  Â  Â  Â  Â  measurementId: "G-WQV8NJN397",Â 
Â  Â  Â  Â  Â  Â  databaseURL: "https://tic-tac-toe-9e69d-default-rtdb.firebaseio.com"Â 
Â  Â  Â  Â  };Â 
Â  Â  Â  Â Â 
Â  Â  Â  Â  let db = null;
Â  Â  Â  Â  if (typeof firebase !== 'undefined') {
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  if (firebase.apps.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  firebase.initializeApp(firebaseConfig);Â 
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  db = firebase.database();
Â  Â  Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Firebase initialization failed:", e);
Â  Â  Â  Â  Â  Â  Â  Â  console.warn("Online multiplayer mode will not work.");
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // --- GAME STATE VARIABLES ---
Â  Â  Â  Â  let boardSize = 3;Â 
Â  Â  Â  Â  let board = Array(boardSize * boardSize).fill('');Â 
Â  Â  Â  Â  let currentPlayer = 'X';Â 
Â  Â  Â  Â  let isMuted = false;Â 
Â  Â  Â  Â  let mode = 'local';Â 
Â  Â  Â  Â  let gameActive = true;Â 
Â  Â  Â  Â  let aiDifficulty = 'hard';Â 
Â  Â  Â  Â  let localPlayer = null;Â 
Â  Â  Â  Â  let roomId = null;Â 
Â  Â  Â  Â  let currentScreen = 'splash-screen';Â 
Â  Â  Â  Â  let playerNames = {
Â  Â  Â  Â  Â  Â  'X': 'Player X',
Â  Â  Â  Â  Â  Â  'O': 'Player O'
Â  Â  Â  Â  };
Â  Â  Â  Â Â 
Â  Â  Â  Â  // --- Timer State Variables ---
Â  Â  Â  Â  let timerInterval = null;Â 
Â  Â  Â  Â  let localMoveStartTime = Date.now();
Â  Â  Â  Â  const TIME_LIMIT_SECONDS = 30;Â 
Â  Â  Â  Â  let autoResetTimeout = null;
Â  Â  Â  Â Â 
Â  Â  Â  Â  // --- DOM Elements (Fetched once) ---
Â  Â  Â  Â  const gameDiv = document.getElementById('game');Â 
Â  Â  Â  Â  const scoreX = document.getElementById('scoreX');Â 
Â  Â  Â  Â  const scoreO = document.getElementById('scoreO');Â 
Â  Â  Â  Â  const scoreDraws = document.getElementById('scoreDraws');Â 
Â  Â  Â  Â  const menuMusic = document.getElementById('menuMusic');Â 
Â  Â  Â  Â  const gameMusic = document.getElementById('gameMusic');Â 
Â  Â  Â  Â  const clickSound = document.getElementById('clickSound');
Â  Â  Â  Â  const winSound = document.getElementById('winSound');
Â  Â  Â  Â  const drawSound = document.getElementById('drawSound');
Â  Â  Â  Â  const roomIdInput = document.getElementById('roomIdInput');Â 
Â  Â  Â  Â  const gameStatusP = document.getElementById('gameStatus');Â 
Â  Â  Â  Â  const onlineScoreboardDiv = document.getElementById('online-scoreboard');Â 
Â  Â  Â  Â  const localScoreboardDiv = document.getElementById('local-scoreboard');Â 
Â  Â  Â  Â  const localPlayerDisplay = document.getElementById('localPlayerDisplay');Â 
Â  Â  Â  Â  const onlineScoreLocal = document.getElementById('onlineScoreLocal');Â 
Â  Â  Â  Â  const onlineScoreOpponent = document.getElementById('onlineScoreOpponent');Â 
Â  Â  Â  Â  const onlineScoreDraws = document.getElementById('onlineScoreDraws');Â 
Â  Â  Â  Â  const chatMessages = document.getElementById('chat-messages');Â 
Â  Â  Â  Â  const chatInput = document.getElementById('chatInput');Â 
Â  Â  Â  Â  const timerDisplay = document.getElementById('timer');Â 
Â  Â  Â  Â  const timerValueSpan = document.getElementById('timerValue');Â 
Â  Â  Â  Â  const backBtn = document.getElementById('backBtn');
Â  Â  Â  Â  const chatOpenBtn = document.getElementById('chatOpenBtn');
Â  Â  Â  Â  const lobbyBoardSizeSpan = document.getElementById('lobbyBoardSize');
Â  Â  Â  Â  const startGameOnlineBtn = document.getElementById('startGameOnlineBtn');
Â  Â  Â  Â  const gameTitle = document.getElementById('gameTitle');
Â  Â  Â  Â  const chatOverlay = document.getElementById('chat-overlay');
Â  Â  Â  Â  const postGameActionsDiv = document.getElementById('post-game-actions');
Â  Â  Â  Â  const loadingSpinnerOnline = document.getElementById('loading-spinner-online');
Â  Â  Â  Â  const nameXDisplay = document.getElementById('nameX');
Â  Â  Â  Â  const nameODisplay = document.getElementById('nameO');
Â  Â  Â  Â  const nameScoreX = document.getElementById('nameScoreX');
Â  Â  Â  Â  const nameScoreO = document.getElementById('nameScoreO');
Â  Â  Â  Â  const gameBoardContainer = document.getElementById('game-board-container');
Â  Â  Â  Â  const gameInfoHeader = document.getElementById('game-info-header');
Â  Â  Â  Â  const scoreboardDiv = document.getElementById('scoreboard');
Â  Â  Â  Â  const splashScreen = document.getElementById('splash-screen');
Â  Â  Â  Â  const playButton = document.getElementById('play-button');
Â  Â  Â  Â  const loadingSpinner = document.getElementById('loading-spinner');
Â  Â  Â  Â Â 
Â  Â  Â  Â  // --- MUSIC, SOUND, & THEME HANDLERS (Unchanged) ---
Â  Â  Â  Â  function setTheme(theme) {
Â  Â  Â  Â  Â  Â  const appBody = document.getElementById('app-body');
Â  Â  Â  Â  Â  Â  const darkBtn = document.querySelector('#theme-controls button:nth-child(1)');
Â  Â  Â  Â  Â  Â  const lightBtn = document.querySelector('#theme-controls button:nth-child(2)');

Â  Â  Â  Â  Â  Â  if (theme === 'light') {
Â  Â  Â  Â  Â  Â  Â  Â  appBody.classList.add('light-theme');
Â  Â  Â  Â  Â  Â  Â  Â  lightBtn.classList.add('active');
Â  Â  Â  Â  Â  Â  Â  Â  darkBtn.classList.remove('active');
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  appBody.classList.remove('light-theme');
Â  Â  Â  Â  Â  Â  Â  Â  darkBtn.classList.add('active');
Â  Â  Â  Â  Â  Â  Â  Â  lightBtn.classList.remove('active');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  function playMusic(audioElem, volume = 0.3) {
Â  Â  Â  Â  Â  Â  if (!isMuted && audioElem && audioElem.paused) {
Â  Â  Â  Â  Â  Â  Â  Â  audioElem.volume = volume;
Â  Â  Â  Â  Â  Â  Â  Â  audioElem.currentTime = 0;Â 
Â  Â  Â  Â  Â  Â  Â  Â  audioElem.play().catch(e => console.log("Audio play prevented:", e));
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  function playSoundEffect(audioElem, volume = 0.8) {
Â  Â  Â  Â  Â  Â  Â if (audioElem && !isMuted) {
Â  Â  Â  Â  Â  Â  Â  Â  audioElem.volume = volume;
Â  Â  Â  Â  Â  Â  Â  Â  audioElem.currentTime = 0;Â 
Â  Â  Â  Â  Â  Â  Â  Â  audioElem.play().catch(e => console.log("Sound effect play prevented:", e));
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function stopMusic(audioElem) {
Â  Â  Â  Â  Â  Â  if (audioElem) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  audioElem.pause();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  function manageMusic(screenId) {
Â  Â  Â  Â  Â  Â  if (screenId === 'game-screen') {
Â  Â  Â  Â  Â  Â  Â  Â  stopMusic(menuMusic);
Â  Â  Â  Â  Â  Â  Â  Â  playMusic(gameMusic, 0.4);Â 
Â  Â  Â  Â  Â  Â  } else if (screenId === 'splash-screen' || screenId === 'home-screen' || screenId === 'online-lobby' || screenId === 'local-config' || screenId === 'ai-config') {
Â  Â  Â  Â  Â  Â  Â  Â  stopMusic(gameMusic);
Â  Â  Â  Â  Â  Â  Â  Â  playMusic(menuMusic, 0.3);
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  stopMusic(menuMusic);
Â  Â  Â  Â  Â  Â  Â  Â  stopMusic(gameMusic);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  function handlePlayClick() {
Â  Â  Â  Â  Â  Â  if (playButton) playButton.style.display = 'none';
Â  Â  Â  Â  Â  Â  if (loadingSpinner) loadingSpinner.style.display = 'block';
Â  Â  Â  Â  Â  Â  playMusic(menuMusic, 0.3);
Â  Â  Â  Â  Â  Â  const LOADING_TIME_MS = 1000;Â 
Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  showScreen('home-screen');
Â  Â  Â  Â  Â  Â  Â  Â  if (splashScreen) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  splashScreen.classList.remove('active');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  splashScreen.style.display = 'none';Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }, 100);Â 
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  if (loadingSpinner) loadingSpinner.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  if (playButton) playButton.style.display = 'block';Â 
Â  Â  Â  Â  Â  Â  }, LOADING_TIME_MS);
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- SCREEN MANAGEMENT ---
Â  Â  Â  Â Â 
Â  Â  Â  Â  function showScreen(screenId, isGameStart = false) {
Â  Â  Â  Â  Â  Â  document.querySelectorAll('.screen').forEach(screen => {
Â  Â  Â  Â  Â  Â  Â  Â  Â screen.classList.remove('active');
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  const screen = document.getElementById(screenId);
Â  Â  Â  Â  Â  Â  if (screen) {
Â  Â  Â  Â  Â  Â  Â  Â  screen.classList.add('active');
Â  Â  Â  Â  Â  Â  Â  Â  currentScreen = screenId;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  postGameActionsDiv.style.display = 'none';

Â  Â  Â  Â  Â  Â  backBtn.style.display = (screenId === 'home-screen' || screenId === 'splash-screen') ? 'none' : 'block';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  chatOpenBtn.style.display = (screenId === 'game-screen' && mode === 'online' && localPlayer) ? 'block' : 'none';
Â  Â  Â  Â  Â  Â  if (screenId !== 'game-screen') {
Â  Â  Â  Â  Â  Â  Â  Â  chatOverlay.classList.remove('visible');Â 
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  manageMusic(screenId);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (screenId === 'game-screen' && isGameStart) {
Â  Â  Â  Â  Â  Â  Â  Â  if (mode === 'local' || mode === 'ai') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  playerNames['X'] = document.getElementById(mode === 'local' ? 'playerNameX' : 'playerNameAIAI').value || 'Player X';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  playerNames['O'] = document.getElementById(mode === 'local' ? 'playerNameO' : 'AI Bot').value || 'Player O';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(mode === 'ai') playerNames['O'] = 'AI Bot (' + aiDifficulty.charAt(0).toUpperCase() + ')';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updatePlayerNamesDisplay();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  gameTitle.textContent = mode === 'local' ? 'LOCAL FRIEND GAME' : `AI GAME (${aiDifficulty.toUpperCase()})`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setBoardSize(boardSize, null, true, currentScreen);Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  calculateAndSetBoardSize();Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  resetGame();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  } else if (mode === 'online' && localPlayer) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  gameTitle.textContent = `ONLINE GAME (${playerNames[localPlayer]})`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  localScoreboardDiv.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  onlineScoreboardDiv.style.display = 'inline-block';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('onlinePlayerName').disabled = true;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (db && roomId) syncGame();Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  calculateAndSetBoardSize();Â 
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } else if (screenId === 'local-config') {
Â  Â  Â  Â  Â  Â  Â  Â  Â mode = 'local';
Â  Â  Â  Â  Â  Â  Â  Â  Â document.getElementById('size3x3Btn').classList.add('active');
Â  Â  Â  Â  Â  Â  } else if (screenId === 'ai-config') {
Â  Â  Â  Â  Â  Â  Â  Â  Â mode = 'ai';
Â  Â  Â  Â  Â  Â  Â  Â  Â document.getElementById('aiSize3x3Btn').classList.add('active');
Â  Â  Â  Â  Â  Â  Â  Â  Â document.querySelector('#aiDifficultyControls button:last-child').classList.add('active');
Â  Â  Â  Â  Â  Â  } else if (screenId === 'online-lobby') {
Â  Â  Â  Â  Â  Â  Â  Â  Â mode = 'online';
Â  Â  Â  Â  Â  Â  Â  Â  Â document.getElementById('onlinePlayerName').disabled = false;
Â  Â  Â  Â  Â  Â  Â  Â  Â document.getElementById('onlineSize3x3Btn').classList.add('active');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  function updatePlayerNamesDisplay() {
Â  Â  Â  Â  Â  Â  nameXDisplay.innerHTML = `X: <strong>${playerNames['X']}</strong>`;
Â  Â  Â  Â  Â  Â  nameODisplay.innerHTML = `O: <strong>${playerNames['O']}</strong>`;
Â  Â  Â  Â  Â  Â  nameScoreX.textContent = playerNames['X'];
Â  Â  Â  Â  Â  Â  nameScoreO.textContent = playerNames['O'];
Â  Â  Â  Â  }

Â  Â  Â  Â  function toggleChatOverlay() {
Â  Â  Â  Â  Â  Â  chatOverlay.classList.toggle('visible');
Â  Â  Â  Â  }

Â  Â  Â  Â  function handleBack(isUserInitiated = false) {
Â  Â  Â  Â  Â  Â  if (chatOverlay.classList.contains('visible')) {
Â  Â  Â  Â  Â  Â  Â  Â  toggleChatOverlay();Â 
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  stopTimer();
Â  Â  Â  Â  Â  Â  if (currentScreen === 'game-screen') {
Â  Â  Â  Â  Â  Â  Â  Â  if (mode === 'online') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showScreen('online-lobby');
Â  Â  Â  Â  Â  Â  Â  Â  } else if (mode === 'ai') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â showScreen('ai-config');
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showScreen('local-config');
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } else if (currentScreen === 'online-lobby' || currentScreen === 'local-config' || currentScreen === 'ai-config') {
Â  Â  Â  Â  Â  Â  Â  Â  if (mode === 'online' && roomId && db) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â db.ref('games/' + roomId).off();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â roomId = null;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â localPlayer = null;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â startGameOnlineBtn.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â loadingSpinnerOnline.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â document.getElementById('onlineStatus').textContent = 'Enter an ID or create a game.';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â document.getElementById('onlinePlayerName').disabled = false;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â playerNames = { 'X': 'Player X', 'O': 'Player O' };
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  showScreen('home-screen');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  mode = 'local';Â 
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  function handleRematch() {
Â  Â  Â  Â  Â  Â  if (mode === 'local' || mode === 'ai') {
Â  Â  Â  Â  Â  Â  Â  Â  resetGame();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // --- Timer Logic (Unchanged) ---
Â  Â  Â  Â  function handleTimeLimitReached() {
Â  Â  Â  Â  Â  Â  if (!gameActive) { stopTimer(); return; }
Â  Â  Â  Â  Â  Â  const nextPlayer = currentPlayer === 'X' ? 'O' : 'X';
Â  Â  Â  Â  Â  Â  const statusMessage = `Time expired for **${playerNames[currentPlayer]}**! Turn passed to **${playerNames[nextPlayer]}**.`;

Â  Â  Â  Â  Â  Â  if (mode === 'online') {
Â  Â  Â  Â  Â  Â  Â  Â  if (currentPlayer === localPlayer) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  gameStatusP.innerHTML = statusMessage;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  db.ref('games/' + roomId).update({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentPlayer: nextPlayer,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  lastMoveTime: firebase.database.ServerValue.TIMESTAMP
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  gameStatusP.innerHTML = statusMessage;
Â  Â  Â  Â  Â  Â  Â  Â  currentPlayer = nextPlayer;
Â  Â  Â  Â  Â  Â  Â  Â  resetLocalTimer();
Â  Â  Â  Â  Â  Â  Â  Â  drawBoard();
Â  Â  Â  Â  Â  Â  Â  Â  if (mode === 'ai' && currentPlayer === 'O') { setTimeout(aiMove, 500); }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function startTimer(startTime) {
Â  Â  Â  Â  Â  Â  stopTimer();Â 
Â  Â  Â  Â  Â  Â  timerDisplay.style.display = 'block';
Â  Â  Â  Â  Â  Â  timerInterval = setInterval(() => {
Â  Â  Â  Â  Â  Â  Â  Â  const elapsedSec = Math.floor((Date.now() - startTime) / 1000);
Â  Â  Â  Â  Â  Â  Â  Â  const remainingSec = TIME_LIMIT_SECONDS - elapsedSec;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (remainingSec <= 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  stopTimer();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  handleTimeLimitReached();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;Â 
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  timerValueSpan.textContent = `${remainingSec}s`;
Â  Â  Â  Â  Â  Â  Â  Â  timerValueSpan.style.color = 'var(--color-text-light)';
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (remainingSec <= 5) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  timerValueSpan.style.color = '#f05a7f';Â 
Â  Â  Â  Â  Â  Â  Â  Â  } else if (remainingSec <= 15) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  timerValueSpan.style.color = '#ff8e3c';Â 
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }, 1000);
Â  Â  Â  Â  }

Â  Â  Â  Â  function stopTimer() {
Â  Â  Â  Â  Â  Â  if (timerInterval) { clearInterval(timerInterval); timerInterval = null; }
Â  Â  Â  Â  Â  Â  if (autoResetTimeout) { clearTimeout(autoResetTimeout); autoResetTimeout = null; }
Â  Â  Â  Â  Â  Â  timerValueSpan.textContent = `${TIME_LIMIT_SECONDS}s`;
Â  Â  Â  Â  Â  Â  timerValueSpan.style.color = 'var(--color-text-light)';Â 
Â  Â  Â  Â  }

Â  Â  Â  Â  function resetLocalTimer() {
Â  Â  Â  Â  Â  Â  localMoveStartTime = Date.now();
Â  Â  Â  Â  Â  Â  if ((mode === 'local' || mode === 'ai') && gameActive) {
Â  Â  Â  Â  Â  Â  Â  Â  stopTimer();
Â  Â  Â  Â  Â  Â  Â  Â  startTimer(localMoveStartTime);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // --- Core Game Logic Functions ---
Â  Â  Â  Â  function setBoardSize(size, button, skipReset = false, location = 'local-config') {
Â  Â  Â  Â  Â  Â  const previousSize = boardSize;
Â  Â  Â  Â  Â  Â  boardSize = size;
Â  Â  Â  Â  Â  Â  const newBoardLength = size * size;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (!skipReset && previousSize !== size) {
Â  Â  Â  Â  Â  Â  Â  Â  board = Array(newBoardLength).fill('');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  gameDiv.style.setProperty('--board-size', size);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // --- UI/Button Activation Logic ---
Â  Â  Â  Â  Â  Â  const sizeControlsId = location === 'local-config' ? 'boardSizeControls' : (location === 'ai-config' ? 'aiBoardSizeControls' : 'onlineBoardSizeControls');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  document.querySelectorAll(`#${sizeControlsId} button`).forEach(btn => {Â 
Â  Â  Â  Â  Â  Â  Â  Â  btn.classList.remove('active');Â 
Â  Â  Â  Â  Â  Â  });Â 
Â  Â  Â  Â  Â  Â  if (button) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  button.classList.add('active');Â 
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (location === 'online-lobby') {
Â  Â  Â  Â  Â  Â  Â  Â  lobbyBoardSizeSpan.textContent = `${size}x${size}`;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // CRITICAL: Call the dynamic sizing function after setting board-size variable
Â  Â  Â  Â  Â  Â  if (currentScreen === 'game-screen' || skipReset) {
Â  Â  Â  Â  Â  Â  Â  Â  Â calculateAndSetBoardSize();Â 
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  if (skipReset) {
Â  Â  Â  Â  Â  Â  Â  Â  drawBoard();Â 
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (location !== 'online-lobby' && mode !== 'online') {
Â  Â  Â  Â  Â  Â  Â  Â  drawBoard();
Â  Â  Â  Â  Â  Â  } else if (location === 'online-lobby' && mode === 'online' && roomId && localPlayer) {
Â  Â  Â  Â  Â  Â  Â  Â  db.ref('games/' + roomId).update({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  boardSize: size,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  board: Array(size * size).fill(''),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentPlayer: 'X',Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  gameActive: true,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  lastMoveTime: firebase.database.ServerValue.TIMESTAMP
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* * CRITICAL FIX 3: Dynamic board sizing to fit available vertical space
Â  Â  Â  Â  Â * This uses the core idea of min(width, available_height)
Â  Â  Â  Â  Â */
Â  Â  Â  Â  function calculateAndSetBoardSize() {
Â  Â  Â  Â  Â  Â  if (currentScreen !== 'game-screen' || !gameBoardContainer || !gameDiv) return;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Get dimensions of the game-screen content area (the whole vertical space between fixed buttons and footer)
Â  Â  Â  Â  Â  Â  const gameScreenContent = document.querySelector('#game-screen .screen-content');
Â  Â  Â  Â  Â  Â  const containerRect = gameScreenContent.getBoundingClientRect();
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Calculate the height occupied by fixed elements (header + scoreboard + margins)
Â  Â  Â  Â  Â  Â  const fixedHeight = gameInfoHeader.offsetHeight + scoreboardDiv.offsetHeight + postGameActionsDiv.offsetHeight + 60; // Extra 60px buffer for padding and small device variations
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Available space for the board is the total container height minus the fixed elements
Â  Â  Â  Â  Â  Â  const availableWidth = containerRect.width;
Â  Â  Â  Â  Â  Â  const availableHeight = containerRect.height - fixedHeight;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // The board must be square and fit in the smallest available dimension
Â  Â  Â  Â  Â  Â  let finalBoardSize = Math.min(availableWidth, availableHeight);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Clamp the size to a reasonable maximum (CSS max-width: 450px)
Â  Â  Â  Â  Â  Â  finalBoardSize = Math.min(finalBoardSize, 450);Â 
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Adjust for board padding (10px on each side = 20px total)
Â  Â  Â  Â  Â  Â  const boardPadding = 20;Â 
Â  Â  Â  Â  Â  Â  finalBoardSize = Math.max(0, finalBoardSize - boardPadding);

Â  Â  Â  Â  Â  Â  // Set the CSS variables for the game board
Â  Â  Â  Â  Â  Â  gameDiv.style.setProperty('--dynamic-board-size', `${finalBoardSize}px`);

Â  Â  Â  Â  Â  Â  // Calculate cell font size based on the final board size
Â  Â  Â  Â  Â  Â  const size = boardSize;
Â  Â  Â  Â  Â  Â  const gapSpace = 8 * (size - 1);
Â  Â  Â  Â  Â  Â  const cellSideLength = (finalBoardSize - gapSpace) / size;
Â  Â  Â  Â  Â  Â  const fontSize = cellSideLength / 2.5;Â 
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  gameDiv.style.setProperty('--font-size', `${fontSize}px`);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  drawBoard();
Â  Â  Â  Â  }

Â  Â  Â  Â  function drawBoard() {Â 
Â  Â  Â  Â  Â  Â  gameDiv.innerHTML = '';Â 

Â  Â  Â  Â  Â  Â  const finalResult = !gameActive ? checkWinner(board, false) : {};
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  board.forEach((val, i) => {Â 
Â  Â  Â  Â  Â  Â  Â  Â  const cell = document.createElement('div');Â 
Â  Â  Â  Â  Â  Â  Â  Â  cell.className = 'cell';Â 
Â  Â  Â  Â  Â  Â  Â  Â  cell.innerHTML = val ? `<strong>${val}</strong>` : '';Â 
Â  Â  Â  Â  Â  Â  Â  Â  cell.setAttribute('data-index', i);Â 
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (!gameActive && finalResult.winningIndices && finalResult.winningIndices.includes(i)) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  cell.classList.add('winner');Â 
Â  Â  Â  Â  Â  Â  Â  Â  }Â 
Â  Â  Â  Â  Â  Â  Â  Â  cell.onclick = () => handleClick(i);Â 
Â  Â  Â  Â  Â  Â  Â  Â  gameDiv.appendChild(cell);Â 
Â  Â  Â  Â  Â  Â  });Â 
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (currentScreen === 'game-screen') {
Â  Â  Â  Â  Â  Â  Â  Â  Â postGameActionsDiv.style.display = gameActive ? 'none' : 'block';
Â  Â  Â  Â  Â  Â  Â  Â  Â if (mode === 'online') postGameActionsDiv.style.display = 'none';Â 

Â  Â  Â  Â  Â  Â  Â  Â  if (mode === 'online' && localPlayer) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!gameActive) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const result = checkWinner(board, false);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const winnerName = result.winner === localPlayer ? 'YOU' : (result.winner === 'Draw' ? 'IT' : 'OPPONENT');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  gameStatusP.innerHTML = `GAME OVER! ${result.winner === 'Draw' ? 'IT\'S A DRAW!' : `<strong>${result.winner} (${winnerName})</strong> WINS!`}. Starting new round in 3 seconds...`;Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(result.winner === 'Draw') playSoundEffect(drawSound);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  else playSoundEffect(winSound);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  stopTimer();Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const turnPlayerName = playerNames[currentPlayer] || currentPlayer;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const turnMessage = (currentPlayer === localPlayer) ? 'YOUR TURN!' : `${turnPlayerName}'S TURN.`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  gameStatusP.innerHTML = `YOU ARE <strong>${localPlayer} (${playerNames[localPlayer]})</strong>. IT IS <strong>${turnMessage}</strong>`;Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }Â 
Â  Â  Â  Â  Â  Â  Â  Â  } else if (gameActive) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  gameStatusP.innerHTML = `<strong>${playerNames[currentPlayer]} (${currentPlayer})</strong>'S TURN.`;
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const result = checkWinner(board, false);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const winnerName = playerNames[result.winner] || result.winner;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â gameStatusP.innerHTML = `GAME OVER! ${result.winner === 'Draw' ? 'IT\'S A DRAW!' : `<strong>${result.winner} (${winnerName})</strong> WINS!`}.`;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }Â 
Â  Â  Â  Â Â 
Â  Â  Â  Â  function handleClick(index) {Â 
Â  Â  Â  Â  Â  Â  if (!gameActive || board[index]) return;Â 
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  playSoundEffect(clickSound);Â 

Â  Â  Â  Â  Â  Â  if (mode === 'online') {Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (currentPlayer !== localPlayer) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  gameStatusP.textContent = `IT IS NOT YOUR TURN (${playerNames[currentPlayer]}'S TURN).`;Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;Â 
Â  Â  Â  Â  Â  Â  Â  Â  }Â 
Â  Â  Â  Â  Â  Â  Â  Â  handleOnlineMove(index);Â 
Â  Â  Â  Â  Â  Â  } else {Â 
Â  Â  Â  Â  Â  Â  Â  Â  board[index] = currentPlayer;Â 
Â  Â  Â  Â  Â  Â  Â  Â  const result = checkWinner(board, true);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (result.winner) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updateLocalScore(result.winner);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(result.winner === 'Draw') playSoundEffect(drawSound);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  else playSoundEffect(winSound);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  drawBoard();
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentPlayer = currentPlayer === 'X' ? 'O' : 'X';Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  drawBoard();Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  resetLocalTimer();Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (mode === 'ai' && currentPlayer === 'O' && boardSize === 3) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(aiMove, 500);Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }Â 
Â  Â  Â  Â  }Â 

Â  Â  Â  Â  function checkWinner(currentBoard, updateGlobalState = false) {
Â  Â  Â  Â  Â  Â  const size = boardSize;
Â  Â  Â  Â  Â  Â  const N = size;Â 

Â  Â  Â  Â  Â  Â  const index = (r, c) => r * size + c;
Â  Â  Â  Â  Â  Â  const isValid = (r, c) => r >= 0 && c >= 0 && r < size && c < size;

Â  Â  Â  Â  Â  Â  const checkLine = (r, c, dr, dc) => {
Â  Â  Â  Â  Â  Â  Â  Â  const player = currentBoard[index(r, c)];
Â  Â  Â  Â  Â  Â  Â  Â  if (!player) return null;

Â  Â  Â  Â  Â  Â  Â  Â  let winningIndices = [index(r, c)];
Â  Â  Â  Â  Â  Â  Â  Â  for (let k = 1; k < N; k++) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const nr = r + k * dr;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const nc = c + k * dc;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!isValid(nr, nc) || currentBoard[index(nr, nc)] !== player) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return null;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  winningIndices.push(index(r, c) + k * (dr * size + dc)); // Correct linear index calculation
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  return { winner: player, winningIndices };
Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  const directions = [
Â  Â  Â  Â  Â  Â  Â  Â  [0, 1], [1, 0], [1, 1], [1, -1]Â 
Â  Â  Â  Â  Â  Â  ];

Â  Â  Â  Â  Â  Â  for (let r = 0; r < size; r++) {
Â  Â  Â  Â  Â  Â  Â  Â  for (let c = 0; c < size; c++) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (currentBoard[index(r, c)]) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  for (let [dr, dc] of directions) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const result = checkLine(r, c, dr, dc);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (result) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (updateGlobalState) { gameActive = false; stopTimer(); }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return result;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  if (!currentBoard.includes('')) {
Â  Â  Â  Â  Â  Â  Â  Â  if (updateGlobalState) { gameActive = false; stopTimer(); }
Â  Â  Â  Â  Â  Â  Â  Â  return { winner: 'Draw' };
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  return {};Â 
Â  Â  Â  Â  }

Â  Â  Â  Â  function updateLocalScore(winner) {Â 
Â  Â  Â  Â  Â  Â  if (winner === 'X') scoreX.textContent = +scoreX.textContent + 1;Â 
Â  Â  Â  Â  Â  Â  else if (winner === 'O') scoreO.textContent = +scoreO.textContent + 1;Â 
Â  Â  Â  Â  Â  Â  else if (winner === 'Draw') scoreDraws.textContent = +scoreDraws.textContent + 1;Â 
Â  Â  Â  Â  }Â 
Â  Â  Â  Â Â 
Â  Â  Â  Â  function updateOnlineScoreboard(scores) {Â 
Â  Â  Â  Â  Â  Â  const localWinCount = localPlayer === 'X' ? scores.scoreX : scores.scoreO;Â 
Â  Â  Â  Â  Â  Â  const opponentWinCount = localPlayer === 'X' ? scores.scoreO : scores.scoreX;Â 
Â  Â  Â  Â  Â  Â  onlineScoreLocal.textContent = localWinCount;Â 
Â  Â  Â  Â  Â  Â  onlineScoreOpponent.textContent = opponentWinCount;Â 
Â  Â  Â  Â  Â  Â  onlineScoreDraws.textContent = scores.draws;Â 
Â  Â  Â  Â  Â  Â  localPlayerDisplay.textContent = `${localPlayer} (${playerNames[localPlayer]})`;Â 
Â  Â  Â  Â  }Â 

Â  Â  Â  Â  function resetGame() {Â 
Â  Â  Â  Â  Â  Â  stopTimer();Â 
Â  Â  Â  Â  Â  Â  const newBoardLength = boardSize * boardSize;
Â  Â  Â  Â  Â  Â  board = Array(newBoardLength).fill('');Â 
Â  Â  Â  Â  Â  Â  currentPlayer = 'X';Â 
Â  Â  Â  Â  Â  Â  gameActive = true;Â 
Â  Â  Â  Â  Â  Â  drawBoard();Â 
Â  Â  Â  Â  Â  Â  resetLocalTimer();Â 
Â  Â  Â  Â  }Â 
Â  Â  Â  Â Â 
Â  Â  Â  Â  function setActiveButton(containerId, activeButton) {Â 
Â  Â  Â  Â  Â  Â  document.querySelectorAll(`#${containerId} button`).forEach(btn => {Â 
Â  Â  Â  Â  Â  Â  Â  Â  btn.classList.remove('active');Â 
Â  Â  Â  Â  Â  Â  });Â 
Â  Â  Â  Â  Â  Â  if (activeButton) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  activeButton.classList.add('active');Â 
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }Â 
Â  Â  Â  Â Â 
Â  Â  Â  Â  function startGame(selectedMode, difficulty, button) {Â 
Â  Â  Â  Â  Â  Â  mode = selectedMode;Â 
Â  Â  Â  Â  Â  Â  setActiveButton('modeControls', null);
Â  Â  Â  Â  Â  Â  setActiveButton('aiDifficultyControls', null);

Â  Â  Â  Â  Â  Â  if (mode === 'local') {
Â  Â  Â  Â  Â  Â  Â  Â  button.classList.add('active');
Â  Â  Â  Â  Â  Â  } else if (mode === 'ai') {
Â  Â  Â  Â  Â  Â  Â  Â  aiDifficulty = difficulty;Â 
Â  Â  Â  Â  Â  Â  Â  Â  button.classList.add('active');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  scoreX.textContent = '0';Â 
Â  Â  Â  Â  Â  Â  scoreO.textContent = '0';Â 
Â  Â  Â  Â  Â  Â  scoreDraws.textContent = '0';Â 
Â  Â  Â  Â  }Â 
Â  Â  Â  Â Â 
Â  Â  Â  Â  // --- CHAT LOGIC (Unchanged) ---
Â  Â  Â  Â  function sendChatMessage(messageOrReaction, isReaction = false) {
Â  Â  Â  Â  Â  Â  if (!db || !roomId || !localPlayer) return;

Â  Â  Â  Â  Â  Â  const message = isReaction ? messageOrReaction : chatInput.value.trim();
Â  Â  Â  Â  Â  Â  if (!message) return;

Â  Â  Â  Â  Â  Â  const chatRef = db.ref('games/' + roomId + '/chat');
Â  Â  Â  Â  Â  Â  chatRef.push({
Â  Â  Â  Â  Â  Â  Â  Â  sender: localPlayer,
Â  Â  Â  Â  Â  Â  Â  Â  message: message,
Â  Â  Â  Â  Â  Â  Â  Â  timestamp: firebase.database.ServerValue.TIMESTAMP,
Â  Â  Â  Â  Â  Â  Â  Â  isReaction: isReactionÂ 
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  if (!isReaction) chatInput.value = '';
Â  Â  Â  Â  }

Â  Â  Â  Â  function syncChat() {
Â  Â  Â  Â  Â  Â  if (!db || !roomId) return;
Â  Â  Â  Â  Â  Â  db.ref('games/' + roomId + '/chat').off();Â 
Â  Â  Â  Â  Â  Â  chatMessages.innerHTML = '';Â 

Â  Â  Â  Â  Â  Â  db.ref('games/' + roomId + '/chat').on('child_added', snapshot => {
Â  Â  Â  Â  Â  Â  Â  Â  const messageData = snapshot.val();
Â  Â  Â  Â  Â  Â  Â  Â  const sender = messageData.sender;
Â  Â  Â  Â  Â  Â  Â  Â  const message = messageData.message;
Â  Â  Â  Â  Â  Â  Â  Â  const senderName = playerNames[sender] || sender;
Â  Â  Â  Â  Â  Â  Â  Â  const isReaction = messageData.isReaction || false;

Â  Â  Â  Â  Â  Â  Â  Â  const msgElement = document.createElement('p');
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if(isReaction) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  msgElement.innerHTML = `<span class="chat-message-system" style="color:#aaa; font-size:0.8rem;">[${senderName} reaction]:</span> <span style="font-size: 1.2rem;">${message}</span>`;
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â msgElement.textContent = `[${senderName}]: ${message}`;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  msgElement.className = sender === 'X' ? 'chat-message-x' : 'chat-message-o';
Â  Â  Â  Â  Â  Â  Â  Â  chatMessages.appendChild(msgElement);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  chatMessages.scrollTop = chatMessages.scrollHeight;
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // --- ONLINE LOGIC (Unchanged) ---
Â  Â  Â  Â  function generateRoomId() {Â 
Â  Â  Â  Â  Â  Â  return Math.random().toString(36).substring(2, 8).toUpperCase();Â 
Â  Â  Â  Â  }Â 
Â  Â  Â  Â Â 
Â  Â  Â  Â  function createGame() {Â 
Â  Â  Â  Â  Â  Â  if (!db) return;
Â  Â  Â  Â  Â  Â  roomId = roomIdInput.value.trim() || generateRoomId();Â 
Â  Â  Â  Â  Â  Â  localPlayer = 'X';Â 
Â  Â  Â  Â  Â  Â  playerNames['X'] = document.getElementById('onlinePlayerName').value.trim() || 'Player X';
Â  Â  Â  Â  Â  Â  playerNames['O'] = 'Waiting...';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  loadingSpinnerOnline.style.display = 'block';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  db.ref('games/' + roomId).set({Â 
Â  Â  Â  Â  Â  Â  Â  Â  board: Array(boardSize * boardSize).fill(''),Â 
Â  Â  Â  Â  Â  Â  Â  Â  boardSize: boardSize,Â 
Â  Â  Â  Â  Â  Â  Â  Â  currentPlayer: 'X',Â 
Â  Â  Â  Â  Â  Â  Â  Â  gameActive: true,Â 
Â  Â  Â  Â  Â  Â  Â  Â  playerX: true,Â 
Â  Â  Â  Â  Â  Â  Â  Â  playerO: false,Â 
Â  Â  Â  Â  Â  Â  Â  Â  playerXName: playerNames['X'],Â 
Â  Â  Â  Â  Â  Â  Â  Â  playerOName: playerNames['O'],Â 
Â  Â  Â  Â  Â  Â  Â  Â  scores: { scoreX: 0, scoreO: 0, draws: 0 },
Â  Â  Â  Â  Â  Â  Â  Â  lastMoveTime: firebase.database.ServerValue.TIMESTAMPÂ 
Â  Â  Â  Â  Â  Â  }).then(() => {Â 
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('onlineStatus').innerHTML = `Game created! Your ID is: <strong>${roomId}</strong>. Waiting for Player O...`;Â 
Â  Â  Â  Â  Â  Â  Â  Â  roomIdInput.value = roomId;Â 
Â  Â  Â  Â  Â  Â  Â  Â  startGameOnlineBtn.style.display = 'block';
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('onlineScoreLocal').textContent = '0';Â 
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('onlineScoreOpponent').textContent = '0';Â 
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('onlineScoreDraws').textContent = '0';Â 
Â  Â  Â  Â  Â  Â  Â  Â  syncGame();Â 
Â  Â  Â  Â  Â  Â  Â  Â  syncChat();Â 
Â  Â  Â  Â  Â  Â  Â  Â  loadingSpinnerOnline.style.display = 'none';
Â  Â  Â  Â  Â  Â  }).catch(e => {
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('onlineStatus').textContent = `Error creating game: ${e.message}`;
Â  Â  Â  Â  Â  Â  Â  Â  loadingSpinnerOnline.style.display = 'none';
Â  Â  Â  Â  Â  Â  });Â 
Â  Â  Â  Â  }Â 
Â  Â  Â  Â Â 
Â  Â  Â  Â  function joinGame() {Â 
Â  Â  Â  Â  Â  Â  if (!db) return;
Â  Â  Â  Â  Â  Â  roomId = roomIdInput.value.trim();Â 
Â  Â  Â  Â  Â  Â  playerNames['O'] = document.getElementById('onlinePlayerName').value.trim() || 'Player O';

Â  Â  Â  Â  Â  Â  if (!roomId) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('onlineStatus').textContent = "Please enter a Room ID.";Â 
Â  Â  Â  Â  Â  Â  Â  Â  return;Â 
Â  Â  Â  Â  Â  Â  }Â 
Â  Â  Â  Â  Â  Â  loadingSpinnerOnline.style.display = 'block';

Â  Â  Â  Â  Â  Â  db.ref('games/' + roomId).once('value', snapshot => {Â 
Â  Â  Â  Â  Â  Â  Â  Â  const gameState = snapshot.val();Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (snapshot.exists() && !gameState.playerO) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  localPlayer = 'O';Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  playerNames['X'] = gameState.playerXName || 'Player X';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (gameState.boardSize !== boardSize) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setBoardSize(gameState.boardSize, null, false, 'online-lobby');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  db.ref('games/' + roomId).update({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  playerO: true,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  playerOName: playerNames['O']Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  })Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .then(() => {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('onlineStatus').innerHTML = `Joined game <strong>${roomId}</strong>! You are O. X goes first. Click 'Go to Game'.`;Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  startGameOnlineBtn.style.display = 'block';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  syncGame();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  syncChat();Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });Â 
Â  Â  Â  Â  Â  Â  Â  Â  } else if (snapshot.exists() && gameState.playerO) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('onlineStatus').textContent = "Room is full.";Â 
Â  Â  Â  Â  Â  Â  Â  Â  } else {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('onlineStatus').textContent = "Room does not exist.";Â 
Â  Â  Â  Â  Â  Â  Â  Â  }Â 
Â  Â  Â  Â  Â  Â  Â  Â  loadingSpinnerOnline.style.display = 'none';
Â  Â  Â  Â  Â  Â  }).catch(e => {
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('onlineStatus').textContent = `Error joining game: ${e.message}`;
Â  Â  Â  Â  Â  Â  Â  Â  loadingSpinnerOnline.style.display = 'none';
Â  Â  Â  Â  Â  Â  });Â 
Â  Â  Â  Â  }Â 
Â  Â  Â  Â Â 
Â  Â  Â  Â  function syncGame() {Â 
Â  Â  Â  Â  Â  Â  if (!db) return;
Â  Â  Â  Â  Â  Â  db.ref('games/' + roomId).off();Â 
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  db.ref('games/' + roomId).on('value', snapshot => {Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (!snapshot.exists()) return;Â 
Â  Â  Â  Â  Â  Â  Â  Â  const gameState = snapshot.val();Â 
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  playerNames['X'] = gameState.playerXName || 'Player X';
Â  Â  Â  Â  Â  Â  Â  Â  playerNames['O'] = gameState.playerOName || 'Waiting...';
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (gameState.boardSize && gameState.boardSize !== boardSize) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setBoardSize(gameState.boardSize, null, true);Â 
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  const prevGameActive = gameActive;
Â  Â  Â  Â  Â  Â  Â  Â  board = gameState.board;Â 
Â  Â  Â  Â  Â  Â  Â  Â  currentPlayer = gameState.currentPlayer;Â 
Â  Â  Â  Â  Â  Â  Â  Â  gameActive = gameState.gameActive;Â 
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (gameState.lastMoveTime && gameActive && localPlayer === currentPlayer) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  startTimer(gameState.lastMoveTime);
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  stopTimer();Â 
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (gameState.scores) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updateOnlineScoreboard(gameState.scores);Â 
Â  Â  Â  Â  Â  Â  Â  Â  }Â 
Â  Â  Â  Â  Â  Â  Â  Â  drawBoard();Â 
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (prevGameActive && !gameActive) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (autoResetTimeout) clearTimeout(autoResetTimeout);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  autoResetTimeout = setTimeout(() => {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (localPlayer === 'X') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  db.ref('games/' + roomId).once('value', currentSnapshot => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const currentGameState = currentSnapshot.val();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const newBoardLength = currentGameState.boardSize * currentGameState.boardSize;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  db.ref('games/' + roomId).update({Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  board: Array(newBoardLength).fill(''),Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentPlayer: 'X',Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  gameActive: true,Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  boardSize: currentGameState.boardSize,Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  lastMoveTime: firebase.database.ServerValue.TIMESTAMPÂ 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }, 3000);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (currentScreen === 'online-lobby' && gameState.playerO && localPlayer === 'X') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('onlineStatus').innerHTML = `Opponent (${playerNames['O']}) has joined! Click 'Go to Game'.`;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }Â 
Â  Â  Â  Â Â 
Â  Â  Â  Â  function handleOnlineMove(index) {Â 
Â  Â  Â  Â  Â  Â  if (!db) return;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const tempBoard = board.slice();
Â  Â  Â  Â  Â  Â  tempBoard[index] = localPlayer;Â 
Â  Â  Â  Â  Â  Â  const result = checkWinner(tempBoard, false);Â 
Â  Â  Â  Â  Â  Â  const nextPlayer = localPlayer === 'X' ? 'O' : 'X';Â 
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  db.ref('games/' + roomId).once('value', snapshot => {
Â  Â  Â  Â  Â  Â  Â  Â  if (!snapshot.exists()) return;
Â  Â  Â  Â  Â  Â  Â  Â  const gameState = snapshot.val();
Â  Â  Â  Â  Â  Â  Â  Â  let newScores = gameState.scores || { scoreX: 0, scoreO: 0, draws: 0 };
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  let updateData = {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  board: tempBoard,Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentPlayer: nextPlayer,Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  gameActive: true,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  lastMoveTime: firebase.database.ServerValue.TIMESTAMPÂ 
Â  Â  Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  Â  Â  if (result.winner || result.winner === 'Draw') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updateData.gameActive = false;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updateData.currentPlayer = localPlayer;Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (result.winner === 'X') newScores.scoreX++;Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  else if (result.winner === 'O') newScores.scoreO++;Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  else if (result.winner === 'Draw') newScores.draws++;Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updateData.scores = newScores;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  db.ref('games/' + roomId).update(updateData);Â 
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  stopTimer();Â 
Â  Â  Â  Â  }Â 

Â  Â  Â  Â  // --- AI (Minimax) Logic (Unchanged) ---
Â  Â  Â  Â  const scores = { 'O': 10, 'X': -10, 'Draw': 0 };Â 

Â  Â  Â  Â  function getEmptyIndices(currentBoard) {
Â  Â  Â  Â  Â  Â  return currentBoard.map((v, i) => v === '' ? i : null).filter(v => v !== null);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  function minimax(currentBoard, player) {
Â  Â  Â  Â  Â  Â  const result = checkWinner(currentBoard, false);Â 
Â  Â  Â  Â  Â  Â  if (result.winner !== undefined && result.winner !== null) { return scores[result.winner]; }
Â  Â  Â  Â  Â  Â  let availableSpots = getEmptyIndices(currentBoard);
Â  Â  Â  Â  Â  Â  if (player === 'O') {
Â  Â  Â  Â  Â  Â  Â  Â  let bestScore = -Infinity;
Â  Â  Â  Â  Â  Â  Â  Â  for (let i of availableSpots) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let nextBoard = currentBoard.slice();Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  nextBoard[i] = player;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let score = minimax(nextBoard, 'X');Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  bestScore = Math.max(score, bestScore);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  return bestScore;
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  let bestScore = Infinity;
Â  Â  Â  Â  Â  Â  Â  Â  for (let i of availableSpots) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let nextBoard = currentBoard.slice();Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  nextBoard[i] = player;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let score = minimax(nextBoard, 'O');Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  bestScore = Math.min(score, bestScore);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  return bestScore;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  function getBestMove(currentBoard) {
Â  Â  Â  Â  Â  Â  let bestScore = -Infinity;
Â  Â  Â  Â  Â  Â  let move = -1;
Â  Â  Â  Â  Â  Â  let availableSpots = getEmptyIndices(currentBoard);
Â  Â  Â  Â  Â  Â  for (let i of availableSpots) {
Â  Â  Â  Â  Â  Â  Â  Â  let tempBoard = currentBoard.slice();Â 
Â  Â  Â  Â  Â  Â  Â  Â  tempBoard[i] = 'O';Â 
Â  Â  Â  Â  Â  Â  Â  Â  let score = minimax(tempBoard, 'X');Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (score > bestScore) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  bestScore = score;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  move = i;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  return move;
Â  Â  Â  Â  }

Â  Â  Â  Â  function aiMove() {Â 
Â  Â  Â  Â  Â  Â  if (!gameActive || currentPlayer !== 'O' || boardSize !== 3) return;Â 
Â  Â  Â  Â  Â  Â  stopTimer();Â 
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  playSoundEffect(clickSound, 0.5);Â 
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  let empty = getEmptyIndices(board);Â 
Â  Â  Â  Â  Â  Â  let move = -1;Â 

Â  Â  Â  Â  Â  Â  if (aiDifficulty === 'easy') {Â 
Â  Â  Â  Â  Â  Â  Â  Â  move = empty[Math.floor(Math.random() * empty.length)];Â 
Â  Â  Â  Â  Â  Â  } else if (aiDifficulty === 'normal') {Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (Math.random() < 0.75) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  move = getBestMove(board);Â 
Â  Â  Â  Â  Â  Â  Â  Â  } else {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  move = empty[Math.floor(Math.random() * empty.length)];Â 
Â  Â  Â  Â  Â  Â  Â  Â  }Â 
Â  Â  Â  Â  Â  Â  } else if (aiDifficulty === 'hard') {Â 
Â  Â  Â  Â  Â  Â  Â  Â  move = getBestMove(board);Â 
Â  Â  Â  Â  Â  Â  }Â 

Â  Â  Â  Â  Â  Â  if (move !== -1) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  board[move] = 'O';Â 
Â  Â  Â  Â  Â  Â  Â  Â  const result = checkWinner(board, true);Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (result.winner) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updateLocalScore(result.winner);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(result.winner === 'Draw') playSoundEffect(drawSound);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  else playSoundEffect(winSound);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  drawBoard();Â 
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentPlayer = 'X';Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  drawBoard();Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  resetLocalTimer();Â 
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }Â 
Â  Â  Â  Â  }Â 

Â  Â  Â  Â  function toggleMute() {Â 
Â  Â  Â  Â  Â  Â  isMuted = !isMuted;Â 
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (menuMusic) menuMusic.muted = isMuted;Â 
Â  Â  Â  Â  Â  Â  if (gameMusic) gameMusic.muted = isMuted;Â 
Â  Â  Â  Â  Â  Â  if (clickSound) clickSound.muted = isMuted;Â 
Â  Â  Â  Â  Â  Â  if (winSound) winSound.muted = isMuted;Â  Â  Â 
Â  Â  Â  Â  Â  Â  if (drawSound) drawSound.muted = isMuted;Â  Â 
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (!isMuted) {
Â  Â  Â  Â  Â  Â  Â  Â  manageMusic(currentScreen);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  document.getElementById('muteBtn').textContent = isMuted ? 'ğŸ”‡' : 'ğŸ”Š';Â 
Â  Â  Â  Â  }Â 
Â  Â  Â  Â Â 
Â  Â  Â  Â Â 
Â  Â  Â  Â  document.addEventListener('DOMContentLoaded', () => {
Â  Â  Â  Â  Â  Â  Â // Initial height calculation
Â  Â  Â  Â  Â  Â  Â setViewportHeight();
Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â // Set initial states for buttons (assuming defaults)
Â  Â  Â  Â  Â  Â  Â document.getElementById('size3x3Btn').classList.add('active');
Â  Â  Â  Â  Â  Â  Â document.querySelector('#aiDifficultyControls button:last-child').classList.add('active');
Â  Â  Â  Â  Â  Â  Â document.getElementById('localPlayBtn').classList.add('active');
Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â // Toggle mute once to ensure it's functional
Â  Â  Â  Â  Â  Â  Â toggleMute();Â 
Â  Â  Â  Â  });
Â  Â  Â  Â Â 
Â  Â  Â  Â  // CRITICAL FIX 4: Force a redraw on resize or orientation change to recalculate cell size
Â  Â  Â  Â  window.addEventListener('resize', () => {
Â  Â  Â  Â  Â  Â  setViewportHeight();
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (currentScreen === 'game-screen') {
Â  Â  Â  Â  Â  Â  Â  Â  Â setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  calculateAndSetBoardSize();Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â }, 100);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  Â  Â Â 
Â  Â  </script>
</body>
</html>
