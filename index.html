<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Tic-Tac-Toe by Seb-Creations</title>
<style>
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
    color: #fff;
    display: flex;
    flex-direction: column;
    align-items: center;
    min-height: 100vh;
    margin: 0;
    padding: 20px;
  }
  h1 {
    margin-bottom: 5px;
  }
  #board {
    display: grid;
    grid-template-columns: repeat(3, 100px);
    grid-gap: 10px;
    margin: 20px 0;
    position: relative;
  }
  .cell {
    width: 100px;
    height: 100px;
    background: rgba(255,255,255,0.2);
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 48px;
    font-weight: bold;
    cursor: pointer;
    border-radius: 10px;
    transition: background 0.3s;
  }
  .cell:hover {
    background: rgba(255,255,255,0.4);
  }
  .disabled {
    pointer-events: none;
    opacity: 0.6;
  }
  #status {
    margin: 10px 0;
    font-size: 1.2rem;
    min-height: 24px;
    font-weight: bold;
  }
  #status span {
    display: inline-block;
    min-width: 30px; 
    text-align: center;
    margin-right: 5px;
  }
  #timer {
    margin: 10px 0;
    font-size: 1.1rem;
    color: #ffcc80; 
    font-weight: bold;
  }
  #scoreboard {
    margin: 10px 0 30px;
    font-size: 1rem;
  }
  #controls {
    display: flex;
    gap: 15px;
    margin-bottom: 15px;
    flex-wrap: wrap;
    justify-content: center;
  }
  select, button {
    padding: 10px 15px;
    font-size: 1rem;
    border-radius: 8px;
    border: none;
    cursor: pointer;
  }
  button {
    background: #2575fc;
    color: white;
    transition: background 0.3s;
  }
  button:hover {
    background: #6a11cb;
  }
  #mute-btn {
    background: #444;
  }
  footer {
    margin-top: auto;
    font-size: 0.9rem;
    color: #ddd;
  }
  #link-section {
    margin: 15px 0;
    font-size: 0.9rem;
    word-break: break-word;
    background: rgba(255,255,255,0.2);
    padding: 10px;
    border-radius: 10px;
    max-width: 320px;
    text-align: center;
  }

  /* --- WINNING LINE STYLES --- */
  .winning-line {
    position: absolute;
    background: #ff4081;
    z-index: 10;
    pointer-events: none;
    opacity: 0.8;
  }

  /* Line dimensions for 3x3 grid */
  .line-row-0, .line-row-1, .line-row-2 { height: 10px; width: 320px; left: -10px; }
  .line-col-0, .line-col-1, .line-col-2 { width: 10px; height: 320px; top: -10px; }
  .line-diag-1, .line-diag-2 { height: 10px; width: 450px; } 

  .line-row-0 { top: 45px; }
  .line-row-1 { top: 155px; }
  .line-row-2 { top: 265px; }

  .line-col-0 { left: 45px; }
  .line-col-1 { left: 155px; }
  .line-col-2 { left: 265px; }

  .line-diag-1 { 
    top: 155px; left: -65px; 
    transform: rotate(45deg); 
  }
  .line-diag-2 { 
    top: 155px; left: -65px; 
    transform: rotate(-45deg); 
  }

</style>
</head>
<body>

<h1>Tic-Tac-Toe</h1>
<div id="timer"></div>
<div id="status">Loading...</div>

<div id="controls">
  <select id="mode-select" title="Select Mode">
    <option value="single">Play vs AI</option>
    <option value="local">Two Players (Local)</option>
    <option value="online">Play Online</option>
  </select>
  <select id="difficulty-select" title="AI Difficulty (only for AI mode)">
    <option value="easy">Easy</option>
    <option value="normal" selected>Normal</option>
    <option value="hard">Hard</option>
  </select>
  <button id="reset-btn">Reset Game</button>
  <button id="mute-btn">ðŸ”Š Mute</button>
</div>

<div id="board"></div>

<div id="scoreboard">
  <div>Player X Wins: <span id="x-wins">0</span></div>
  <div>Player O Wins: <span id="o-wins">0</span></div>
  <div>Draws: <span id="draws">0</span></div>
</div>

<div id="link-section" style="display:none;">
  Share this link to play online:<br />
  <a href="#" target="_blank" id="game-link"></a>
</div>

<footer>Developed by Seb-Creations</footer>

<audio id="bg-music" loop>
  <source src="https://opengameart.org/sites/default/files/Happy%20Ukulele%20Background%20Music.mp3" type="audio/mpeg" />
</audio>

<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

<script>
  // Your Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyAFUoT40IjaiqH2791QvyNUP6SakHarupY",
    authDomain: "tic-tac-toe-9e69d.firebaseapp.com",
    databaseURL: "https://tic-tac-toe-9e69d-default-rtdb.firebaseio.com",
    projectId: "tic-tac-toe-9e69d",
    storageBucket: "tic-tac-toe-9e69d.appspot.com",
    messagingSenderId: "279666476240",
    appId: "1:279666476240:web:106c4481fbda677424cad5"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // --- GLOBAL GAME VARIABLES ---
  const boardEl = document.getElementById('board');
  const statusEl = document.getElementById('status');
  const xWinsEl = document.getElementById('x-wins');
  const oWinsEl = document.getElementById('o-wins');
  const drawsEl = document.getElementById('draws');
  const resetBtn = document.getElementById('reset-btn');
  const modeSelect = document.getElementById('mode-select');
  const difficultySelect = document.getElementById('difficulty-select');
  const linkSection = document.getElementById('link-section');
  const gameLink = document.getElementById('game-link');
  const muteBtn = document.getElementById('mute-btn');
  const bgMusic = document.getElementById('bg-music');
  const timerEl = document.getElementById('timer');

  let board = ["", "", "", "", "", "", "", "", ""];
  let currentPlayer = "X";
  let gameActive = true;
  let scores = { X: 0, O: 0, draw: 0 };

  let isOnline = false;
  let gameId = null;
  let playerSymbol = null;
  let difficulty = 'normal';
  let muted = false;

  let timerInterval;
  const turnTimeLimit = 10; 

  // Winning combos mapped to CSS line classes for strike-through
  const winningCombos = [
    { combo: [0, 1, 2], lineClass: 'line-row-0' },
    { combo: [3, 4, 5], lineClass: 'line-row-1' },
    { combo: [6, 7, 8], lineClass: 'line-row-2' },
    { combo: [0, 3, 6], lineClass: 'line-col-0' },
    { combo: [1, 4, 7], lineClass: 'line-col-1' },
    { combo: [2, 5, 8], lineClass: 'line-col-2' },
    { combo: [0, 4, 8], lineClass: 'line-diag-1' },
    { combo: [2, 4, 6], lineClass: 'line-diag-2' }
  ];


  // --- INITIALIZATION AND EVENT LISTENERS ---

  // UPDATED: Removed score clearing logic from resetBtn
  resetBtn.addEventListener('click', () => {
    resetGameLocal();
    // Logic for online reset would still go here
  });
  modeSelect.addEventListener('change', initializeGameMode);
  difficultySelect.addEventListener('change', () => difficulty = difficultySelect.value);
  muteBtn.addEventListener('click', toggleMute);

  function init() {
    createBoard();
    updateScores();
    initializeGameMode();
  }
  init();


  // --- CORE GAME LOGIC ---

  function createBoard() {
    boardEl.innerHTML = '';
    for (let i = 0; i < 9; i++) {
      const cell = document.createElement('div');
      cell.classList.add('cell');
      cell.dataset.index = i;
      cell.addEventListener('click', () => handleCellClick(i));
      boardEl.appendChild(cell);
    }
  }

  function handleCellClick(index) {
    if (!gameActive || board[index] !== "") return;

    const mode = modeSelect.value;
    let allowedToMove = false;

    if (mode === 'single') { allowedToMove = currentPlayer === 'X'; } 
    else if (mode === 'local') { allowedToMove = true; } 
    else if (mode === 'online') { allowedToMove = currentPlayer === playerSymbol; }

    if (allowedToMove) {
      makeMove(index, currentPlayer);
    }
  }

  function makeMove(index, symbol) {
    if (!gameActive || board[index] !== "") return;

    board[index] = symbol;
    updateBoardUI();

    const winInfo = checkWin(symbol);
    if (winInfo) {
      endGame(symbol, winInfo.lineClass);
    } else if (checkDraw()) {
      endGame('draw');
    } else {
      switchPlayer();
      startTimer();

      if (modeSelect.value === 'single' && currentPlayer === 'O') {
        setTimeout(aiMove, 500);
      }
    }
  }

  // End the game
  function endGame(winner, lineClass) {
    gameActive = false;
    clearInterval(timerInterval);
    timerEl.textContent = '';

    if (winner === 'draw') {
      scores.draw++;
      updateStatus("It's a Draw!");
    } else {
      scores[winner]++;
      updateStatus(`Player ${winner} Wins!`);
      highlightWinningCells(lineClass);
    }
    updateScores();
    
    // Auto-reset after 2 seconds to prepare for next game, keeping score
    setTimeout(resetGameLocal, 2000); 
  }

  function highlightWinningCells(lineClass) {
    const line = document.createElement('div');
    line.classList.add('winning-line', lineClass);
    boardEl.appendChild(line);
  }


  // --- UTILITY FUNCTIONS ---

  function updateBoardUI() {
    boardEl.querySelectorAll('.winning-line').forEach(line => line.remove());

    boardEl.querySelectorAll('.cell').forEach(cell => {
      cell.textContent = board[cell.dataset.index];
    });
  }

  function checkWin(player) {
    return winningCombos.find(combo =>
      combo.combo.every(index => board[index] === player)
    );
  }

  function checkDraw() {
    return board.every(cell => cell !== "");
  }

  function switchPlayer() {
    currentPlayer = currentPlayer === "X" ? "O" : "X";
    updateStatus(`'s turn`);
  }

  function updateStatus(text) {
    let symbolIndicator = '';
    if (gameActive) {
      symbolIndicator = `<span style="color: ${currentPlayer === 'X' ? '#ff4081' : '#448aff'}; font-size: 1.5em;">${currentPlayer}</span>`;
    }
    statusEl.innerHTML = `${symbolIndicator} ${text}`;
  }

  function updateScores() {
    xWinsEl.textContent = scores.X;
    oWinsEl.textContent = scores.O;
    drawsEl.textContent = scores.draw;
  }

  // Resets board only, preserves scores
  function resetGameLocal() {
    board.fill("");
    gameActive = true;
    currentPlayer = "X";
    updateBoardUI();
    updateStatus(`'s turn`);
    
    // Only start timer if not in online mode
    if (modeSelect.value !== 'online') {
        startTimer();
    } else {
        clearInterval(timerInterval);
        timerEl.textContent = '';
    }
  }


  // --- TIMER FUNCTIONS ---
  function startTimer() {
    if (modeSelect.value === 'online' || !gameActive) {
      clearInterval(timerInterval);
      timerEl.textContent = '';
      return;
    }

    clearInterval(timerInterval);
    let timeLeft = turnTimeLimit;
    timerEl.textContent = `Time left for ${currentPlayer}: ${timeLeft}s`;

    timerInterval = setInterval(() => {
      timeLeft--;
      timerEl.textContent = `Time left for ${currentPlayer}: ${timeLeft}s`;

      if (timeLeft <= 0) {
        clearInterval(timerInterval);
        const winner = currentPlayer === "X" ? "O" : "X";
        updateStatus(`Time's up! Player ${currentPlayer} forfeits.`);
        endGame(winner); 
      }
    }, 1000);
  }


  // --- MODE AND MUSIC FUNCTIONS (UPDATED Online Logic) ---

  function initializeGameMode() {
    const mode = modeSelect.value;
    difficultySelect.disabled = mode !== 'single';
    isOnline = mode === 'online';

    resetGameLocal();
    
    if (mode === 'online') {
        // 1. Generate a unique game ID (using Firebase push key)
        const newGameRef = db.ref('games').push();
        gameId = newGameRef.key;
        
        // 2. Set the initial game state in Firebase
        newGameRef.set({
            board: board,
            currentPlayer: 'X',
            gameActive: true,
            playerX: 'host',
            playerO: null,
        });
        playerSymbol = 'X';

        // 3. Create the sharable URL
        const shareURL = `${window.location.href.split('?')[0]}?game=${gameId}`;
        
        // 4. Display the link section
        gameLink.href = shareURL;
        gameLink.textContent = shareURL;
        linkSection.style.display = 'block'; 

        updateStatus(`Waiting for opponent. Share the link!`);
        clearInterval(timerInterval);
        timerEl.textContent = '';
    } else {
        linkSection.style.display = 'none';
        startTimer();
    }
  }

  function toggleMute() {
    muted = !muted;
    if (muted) {
      bgMusic.pause();
      muteBtn.textContent = 'ðŸ”‡ Unmute';
    } else {
      bgMusic.play().catch(e => {
        console.log('Music play failed:', e);
      });
      muteBtn.textContent = 'ðŸ”Š Mute';
    }
  }

  // --- AI LOGIC ---

  function aiMove() {
    if (!gameActive) return;
    let moveIndex;
    const emptyIndices = board.map((v, i) => v === "" ? i : -1).filter(i => i !== -1);

    if (difficulty === 'easy' || difficulty === 'normal' || difficulty === 'hard') {
      moveIndex = emptyIndices[Math.floor(Math.random() * emptyIndices.length)];
    }

    if (moveIndex !== undefined) {
      makeMove(moveIndex, 'O');
    }
  }
</script>
</body>
</html>
